<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
  <title>Catan Connect</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body { height:100%; margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    
    /* ========== EASY COLOR CUSTOMIZATION ========== */
    :root {
      --color-dice-number: #ffffff;
      --color-sun-active: #ffffff;
      --color-moon-active: #ffffff;
      --color-robber-label: #ffffff;
      --color-robber-number: #ffffff;
      --color-timer: #ffffff;
      --color-round-number: #ffffff;
    }
    
    .dice-number { color: var(--color-dice-number); }
    .sun-active { color: var(--color-sun-active); }
    .moon-active { color: var(--color-moon-active); }
    .robber-label { color: var(--color-robber-label); }
    .robber-number { color: var(--color-robber-number); }
    .timer-text { color: var(--color-timer); }
    .round-number { color: var(--color-round-number); }
    /* ============================================== */
    
    /* Background images */
    .bg-sun {
      /* Sun/Orange background - burnt orange */
      background: linear-gradient(135deg, #cc5500 0%, #ff6600 50%, #cc5500 100%);
      background-size: cover;
      background-position: center;
    }
    
    .bg-moon {
      /* Moon/Blue background - navy blue */
      background: linear-gradient(135deg, #001f3f 0%, #003366 50%, #001f3f 100%);
      background-size: cover;
      background-position: center;
    }
    
    .bg-flash {
      /* Not used - text flashes instead */
      display: none;
    }
    
    .flash-red {
      color: #ff0000 !important;
      transition: color 0.3s ease-in-out;
    }
    
    .bg-warning {
      /* Robber warning background - forest green */
      background: linear-gradient(135deg, #0d4d0d 0%, #1a661a 50%, #0d4d0d 100%);
      background-size: cover;
      background-position: center;
    }
    
    /* Circle for dice number - responsive */
    .dice-circle {
      width: min(400px, 80vw);
      height: min(400px, 80vw);
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: center;
      border: 8px solid rgba(255, 255, 255, 0.4);
      position: relative;
    }
    
    /* Responsive font sizes */
    @media (max-width: 768px) {
      .dice-number { font-size: 10rem !important; }
      .robber-number { font-size: 10rem !important; }
      .robber-label { font-size: 6rem !important; }
      .active-label { font-size: 4rem !important; }
      .timer-text { font-size: 4rem !important; }
    }
    
    @media (max-width: 480px) {
      .dice-number { font-size: 7rem !important; }
      .robber-number { font-size: 7rem !important; }
      .robber-label { font-size: 4rem !important; }
      .active-label { font-size: 2.5rem !important; }
      .timer-text { font-size: 3rem !important; }
    }
    
    .clamp-center { display:flex; align-items:center; justify-content:center; }
    
    /* Modal styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
    // State
    let state = {
      round: 1,
      roundTime: 30,
      timeLeft: 30,
      isPaused: true,
      diceNumber: null,
      robberNumber: null,
      showWarning: false,
      countdownPhase: false,
      countdownValue: 3,
      showStats: false,
      roundLog: [], // {round, dice, robber, duration}
      currentCountdownInterval: null,
      showPauseModal: false,
      // Settings
      vibrationEnabled: true,
      flashSpeed: 600,
      robberStartRound: 11,
      currentView: 'stats', // 'stats', 'settings', 'info', 'advanced'
      roundStartTime: null
    };

    let intervalTimer = null;
    let intervalFlash = null;
    let flashState = false;

    // Load saved state on page load
    function loadState() {
      const saved = localStorage.getItem('catanTimerState');
      if (saved) {
        try {
          const parsed = JSON.parse(saved);
          // Restore relevant state (but keep game paused)
          state.round = parsed.round || 1;
          state.roundTime = parsed.roundTime || 30;
          state.roundLog = parsed.roundLog || [];
          state.diceNumber = parsed.diceNumber || null;
          state.robberNumber = parsed.robberNumber || null;
          state.vibrationEnabled = parsed.vibrationEnabled !== undefined ? parsed.vibrationEnabled : true;
          state.flashSpeed = parsed.flashSpeed || 600;
          state.robberStartRound = parsed.robberStartRound || 11;
          // Always start paused after reload
          state.isPaused = true;
          state.timeLeft = parsed.timeLeft || state.roundTime;
        } catch(e) {
          console.error('Failed to load saved state', e);
        }
      }
    }

    // Save state to localStorage
    function saveState() {
      const toSave = {
        round: state.round,
        roundTime: state.roundTime,
        timeLeft: state.timeLeft,
        diceNumber: state.diceNumber,
        robberNumber: state.robberNumber,
        roundLog: state.roundLog,
        vibrationEnabled: state.vibrationEnabled,
        flashSpeed: state.flashSpeed,
        robberStartRound: state.robberStartRound
      };
      localStorage.setItem('catanTimerState', JSON.stringify(toSave));
    }

    // Dice utilities - VERIFIED CORRECT
    // This simulates rolling 2d6 and adding them together
    function rollDice() {
      const d1 = Math.floor(Math.random()*6) + 1; // 1-6
      const d2 = Math.floor(Math.random()*6) + 1; // 1-6
      return d1 + d2; // 2-12
    }
    
    // Get random number, optionally excluding 7
    function getRandomNumber(excludeSeven=false) {
      let r = rollDice();
      if (excludeSeven) {
        while (r === 7) r = rollDice();
      }
      return r;
    }
    
    /* MATH VERIFICATION:
     * - rollDice() generates 1-6 for each die, then adds them = 2-12 range ‚úì
     * - Before round 11: getRandomNumber(true) excludes 7s ‚úì
     * - Round 11+: getRandomNumber(false) allows 7s ‚úì
     * - When 7 is rolled: robberNumber gets a separate rollDice() call ‚úì
     * This correctly simulates Catan dice mechanics!
     */

    // Log a round
    function logRound(dice, robber) {
      const duration = state.roundStartTime ? Math.round((Date.now() - state.roundStartTime) / 1000) : state.roundTime;
      state.roundLog.push({
        round: state.round,
        dice: dice,
        robber: robber,
        duration: duration
      });
      state.roundStartTime = Date.now();
    }

    // Start a new round
    function startNewRound() {
      const robberPossible = state.round >= state.robberStartRound;
      let newDice;
      if (robberPossible) {
        newDice = getRandomNumber(false); // Allow 7s
        if (newDice === 7) {
          state.robberNumber = rollDice();
          // Handle desert case
          if (state.robberNumber === 7) {
            state.robberNumber = 'DESERT (7)';
          }
          logRound(newDice, state.robberNumber);
        } else {
          state.robberNumber = null;
          logRound(newDice, null);
        }
      } else {
        newDice = getRandomNumber(true); // Exclude 7s
        state.robberNumber = null;
        logRound(newDice, null);
      }
      state.diceNumber = newDice;
      
      // Increase round time by 10 seconds from round 11 onwards
      if (state.round >= 11) {
        state.timeLeft = state.roundTime + 10;
      } else {
        state.timeLeft = state.roundTime;
      }
      
      state.showWarning = false;
      saveState();
      render();
    }

    function startTimer() {
      stopTimerAndFlash();
      if (!state.isPaused && !state.countdownPhase && !state.showWarning) {
        intervalTimer = setInterval(() => {
          if (state.timeLeft <= 1) {
            handleNext();
          } else {
            state.timeLeft--;
            if (state.timeLeft === 5 && state.vibrationEnabled && navigator.vibrate) {
              try { navigator.vibrate([200,100,200]); } catch(e){}
            }
            saveState();
            render();
          }
        }, 1000);

        // Flash text red when <= 5 seconds
        intervalFlash = setInterval(() => {
          const shouldFlash = (state.timeLeft <= 5 && state.timeLeft > 0 && !state.isPaused && !state.countdownPhase && !state.showWarning);
          if (shouldFlash) {
            flashState = !flashState;
            const diceNum = document.querySelector('.dice-number');
            const timer = document.querySelector('.timer-text');
            const activeLabel = document.querySelector('.active-label');
            
            if (flashState) {
              if (diceNum) diceNum.classList.add('flash-red');
              if (timer) timer.classList.add('flash-red');
              if (activeLabel) activeLabel.classList.add('flash-red');
            } else {
              if (diceNum) diceNum.classList.remove('flash-red');
              if (timer) timer.classList.remove('flash-red');
              if (activeLabel) activeLabel.classList.remove('flash-red');
            }
          } else {
            const diceNum = document.querySelector('.dice-number');
            const timer = document.querySelector('.timer-text');
            const activeLabel = document.querySelector('.active-label');
            if (diceNum) diceNum.classList.remove('flash-red');
            if (timer) timer.classList.remove('flash-red');
            if (activeLabel) activeLabel.classList.remove('flash-red');
          }
        }, state.flashSpeed);
      }
    }

    function stopTimerAndFlash() {
      if (intervalTimer) { clearInterval(intervalTimer); intervalTimer = null; }
      if (intervalFlash) { clearInterval(intervalFlash); intervalFlash = null; }
      const diceNum = document.querySelector('.dice-number');
      const timer = document.querySelector('.timer-text');
      const activeLabel = document.querySelector('.active-label');
      if (diceNum) diceNum.classList.remove('flash-red');
      if (timer) timer.classList.remove('flash-red');
      if (activeLabel) activeLabel.classList.remove('flash-red');
      flashState = false;
    }

    function handleNext() {
      if (state.currentCountdownInterval) {
        clearInterval(state.currentCountdownInterval);
        state.currentCountdownInterval = null;
      }
      
      state.countdownPhase = true;
      state.countdownValue = 3;
      state.isPaused = true;
      stopTimerAndFlash();
      render();

      const countdownInterval = setInterval(() => {
        if (state.countdownValue > 1) {
          state.countdownValue--;
          render();
        } else {
          clearInterval(countdownInterval);
          state.countdownPhase = false;

          if (state.robberNumber === null) state.round++;

          if (state.robberNumber === null && state.round === 11) {
            state.showWarning = true;
            render();
            // User must manually skip warning screen
          } else {
            startNewRound();
            state.isPaused = false;
            startTimer();
          }
        }
      }, 1000);
      
      state.currentCountdownInterval = countdownInterval;
    }

    function togglePause() {
      state.isPaused = !state.isPaused;
      if (state.isPaused) {
        stopTimerAndFlash();
      } else {
        startTimer();
      }
      render();
    }
    
    function skipWarning() {
      state.showWarning = false;
      state.roundTime += 10; // Permanently increase round time by 10 seconds
      startNewRound();
      state.isPaused = false;
      startTimer();
    }

    function handleStart() {
      startNewRound();
      state.isPaused = false;
      startTimer();
    }

    function adjustRoundTime(delta) {
      state.roundTime = Math.max(10, Math.min(120, state.roundTime + delta));
      saveState();
      render();
    }

    function showStatsPrompt() {
      state.showPauseModal = true;
      render();
    }

    function handleStatsChoice(shouldPause) {
      state.showPauseModal = false;
      if (shouldPause && !state.isPaused) {
        togglePause();
      }
      state.showStats = true;
      render();
    }

    function closeStats() {
      state.showStats = false;
      render();
    }
    
    function showNewGameConfirm() {
      if (confirm('Are you sure you want to start a new game? This will reset everything and clear all stats.')) {
        // Clear everything
        state.round = 1;
        state.roundTime = 30;
        state.timeLeft = 30;
        state.isPaused = true;
        state.diceNumber = null;
        state.robberNumber = null;
        state.showWarning = false;
        state.countdownPhase = false;
        state.roundLog = [];
        
        // Keep settings but clear game state
        localStorage.removeItem('catanTimerState');
        saveState();
        
        // Stop all timers
        stopTimerAndFlash();
        if (state.currentCountdownInterval) {
          clearInterval(state.currentCountdownInterval);
          state.currentCountdownInterval = null;
        }
        
        state.showStats = false;
        render();
      }
    }
    
    function changeView(view) {
      state.currentView = view;
      render();
    }
    
    function toggleSetting(setting) {
      state[setting] = !state[setting];
      saveState();
      render();
    }
    
    function updateSetting(setting, value) {
      state[setting] = parseInt(value);
      saveState();
      
      // If changing flash speed while game is running, restart timer
      if (setting === 'flashSpeed' && !state.isPaused) {
        startTimer();
      }
      
      render();
    }

    function copyStats() {
      const text = state.roundLog.map(log => 
        `Round ${log.round}: Dice ${log.dice}${log.robber ? ` (Robber: ${log.robber})` : ''} - ${log.duration}s`
      ).join('\n');
      navigator.clipboard.writeText(text).then(() => {
        alert('Stats copied to clipboard!');
      });
    }

    function exportStatsCSV() {
      const headers = 'Round,Dice Roll,Robber Number,Duration (seconds)\n';
      const rows = state.roundLog.map(log => 
        `${log.round},${log.dice},${log.robber || ''},${log.duration}`
      ).join('\n');
      
      const csv = headers + rows;
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `catan-game-stats-${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      window.URL.revokeObjectURL(url);
    }

    function render() {
      const app = document.getElementById('app');

      // Pause modal
      if (state.showPauseModal) {
        app.innerHTML = `
          <div class="modal-overlay">
            <div class="bg-gray-800 p-8 rounded-lg text-white text-center max-w-md">
              <h2 class="text-2xl font-bold mb-4">View Statistics</h2>
              <p class="mb-6">Would you like to pause the game?</p>
              <div class="flex gap-4 justify-center">
                <button onclick="handleStatsChoice(true)" class="px-6 py-3 bg-blue-600 rounded hover:bg-blue-700 font-bold">
                  Yes, Pause
                </button>
                <button onclick="handleStatsChoice(false)" class="px-6 py-3 bg-green-600 rounded hover:bg-green-700 font-bold">
                  No, Continue
                </button>
              </div>
            </div>
          </div>
        `;
        return;
      }

      // Stats view
      if (state.showStats) {
        // Navigation tabs with hover tooltips
        const tabs = `
          <div class="flex gap-2 mb-6 overflow-x-auto flex-wrap">
            <button onclick="changeView('stats')" title="View game statistics and round history" class="px-4 py-2 rounded font-bold ${state.currentView === 'stats' ? 'bg-blue-600' : 'bg-gray-700 hover:bg-gray-600'}">
              üìä Stats
            </button>
            <button onclick="changeView('advanced')" title="View dice probability analysis and advanced metrics" class="px-4 py-2 rounded font-bold ${state.currentView === 'advanced' ? 'bg-blue-600' : 'bg-gray-700 hover:bg-gray-600'}">
              üìà Advanced
            </button>
            <button onclick="changeView('settings')" title="Configure game settings and preferences" class="px-4 py-2 rounded font-bold ${state.currentView === 'settings' ? 'bg-blue-600' : 'bg-gray-700 hover:bg-gray-600'}">
              ‚öôÔ∏è Settings
            </button>
            <button onclick="changeView('info')" title="View keyboard shortcuts, rules, and about information" class="px-4 py-2 rounded font-bold ${state.currentView === 'info' ? 'bg-blue-600' : 'bg-gray-700 hover:bg-gray-600'}">
              ‚ÑπÔ∏è Info
            </button>
            <button onclick="showNewGameConfirm()" title="Start a new game and reset all statistics" class="px-4 py-2 rounded font-bold bg-red-600 hover:bg-red-700">
              üîÑ New Game
            </button>
          </div>
        `;
        
        let content = '';
        
        // STATS VIEW
        if (state.currentView === 'stats') {
          const statsHTML = state.roundLog.map(log => `
            <tr class="border-b border-gray-700">
              <td class="px-4 py-3 font-bold text-yellow-300">${log.round}</td>
              <td class="px-4 py-3 text-center">
                <span class="text-2xl font-bold ${log.dice === 7 ? 'text-red-400' : 'text-white'}">${log.dice}</span>
              </td>
              <td class="px-4 py-3 text-center ${log.robber ? 'text-red-400 font-bold' : 'text-gray-500'}">
                ${log.robber || '‚Äî'}
              </td>
              <td class="px-4 py-3 text-gray-400 text-sm">${log.duration}s</td>
            </tr>
          `).join('');

          const totalRounds = state.roundLog.length;
          const robberRounds = state.roundLog.filter(log => log.robber !== null).length;
          const diceCounts = {};
          state.roundLog.forEach(log => {
            diceCounts[log.dice] = (diceCounts[log.dice] || 0) + 1;
          });
          const mostCommon = Object.entries(diceCounts).sort((a, b) => b[1] - a[1])[0];

          content = `
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
              <div class="bg-gradient-to-br from-blue-600 to-blue-800 p-4 rounded-lg">
                <div class="text-sm opacity-80">Total Rounds</div>
                <div class="text-3xl font-bold">${totalRounds}</div>
              </div>
              <div class="bg-gradient-to-br from-red-600 to-red-800 p-4 rounded-lg">
                <div class="text-sm opacity-80">Robber Activations</div>
                <div class="text-3xl font-bold">${robberRounds}</div>
              </div>
              <div class="bg-gradient-to-br from-green-600 to-green-800 p-4 rounded-lg">
                <div class="text-sm opacity-80">Most Common Roll</div>
                <div class="text-3xl font-bold">${mostCommon ? `${mostCommon[0]} (√ó${mostCommon[1]})` : 'N/A'}</div>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-4">
              <button onclick="copyStats()" title="Copy statistics to clipboard" class="px-4 py-3 bg-green-600 rounded hover:bg-green-700 font-bold text-sm md:text-base">
                üìã Copy Stats
              </button>
              
              <button onclick="exportStatsCSV()" title="Download statistics as CSV file" class="px-4 py-3 bg-purple-600 rounded hover:bg-purple-700 font-bold text-sm md:text-base">
                üì• Export CSV
              </button>
            </div>

            <div class="bg-gray-800 rounded-lg overflow-hidden">
              <div class="overflow-x-auto max-h-96">
                <table class="w-full">
                  <thead class="bg-gray-700 sticky top-0">
                    <tr>
                      <th class="px-4 py-3 text-left text-sm font-bold">Round</th>
                      <th class="px-4 py-3 text-center text-sm font-bold">Dice</th>
                      <th class="px-4 py-3 text-center text-sm font-bold">Robber</th>
                      <th class="px-4 py-3 text-left text-sm font-bold">Duration</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${statsHTML.length > 0 ? statsHTML : '<tr><td colspan="4" class="text-center text-gray-400 py-8">No rounds played yet</td></tr>'}
                  </tbody>
                </table>
              </div>
            </div>
          `;
        }
        
        // ADVANCED STATS VIEW
        else if (state.currentView === 'advanced') {
          // Calculate advanced stats
          const diceCounts = {2:0, 3:0, 4:0, 5:0, 6:0, 8:0, 9:0, 10:0, 11:0, 12:0};
          const robberDiceCounts = {2:0, 3:0, 4:0, 5:0, 6:0, 7:0, 8:0, 9:0, 10:0, 11:0, 12:0};
          let sevenCount = 0;
          
          state.roundLog.forEach(log => {
            if (log.dice === 7) {
              sevenCount++;
              if (log.robber && log.robber !== 'Desert') {
                robberDiceCounts[log.robber] = (robberDiceCounts[log.robber] || 0) + 1;
              }
            } else {
              diceCounts[log.dice] = (diceCounts[log.dice] || 0) + 1;
            }
          });
          
          // Expected probabilities for 2d6 (excluding 7)
          const expectedProb = {
            2: 2.78, 3: 5.56, 4: 8.33, 5: 11.11, 6: 13.89,
            8: 13.89, 9: 11.11, 10: 8.33, 11: 5.56, 12: 2.78
          };
          
          const totalRolls = state.roundLog.filter(log => log.dice !== 7).length;
          
          // Calculate longest streak without robber
          let currentStreak = 0;
          let longestStreak = 0;
          state.roundLog.forEach(log => {
            if (log.robber === null) {
              currentStreak++;
              longestStreak = Math.max(longestStreak, currentStreak);
            } else {
              currentStreak = 0;
            }
          });
          
          // Average round duration
          const totalDuration = state.roundLog.reduce((sum, log) => sum + (log.duration || 0), 0);
          const avgDuration = state.roundLog.length > 0 ? Math.round(totalDuration / state.roundLog.length) : 0;
          
          const probabilityChart = Object.keys(diceCounts).map(num => {
            const actual = totalRolls > 0 ? ((diceCounts[num] / totalRolls) * 100).toFixed(1) : 0;
            const expected = expectedProb[num];
            const diff = totalRolls > 0 ? (actual - expected).toFixed(1) : 0;
            
            return `
              <div class="mb-4">
                <div class="flex justify-between mb-1">
                  <span class="font-bold">${num}</span>
                  <span class="text-sm">
                    <span class="text-blue-400">Actual: ${actual}%</span> | 
                    <span class="text-gray-400">Expected: ${expected}%</span> |
                    <span class="${diff >= 0 ? 'text-green-400' : 'text-red-400'}">${diff > 0 ? '+' : ''}${diff}%</span>
                  </span>
                </div>
                <div class="relative h-8 bg-gray-700 rounded overflow-hidden">
                  <div class="absolute h-full bg-gray-500 opacity-30" style="width: ${expected}%"></div>
                  <div class="absolute h-full bg-blue-500" style="width: ${actual}%"></div>
                  <div class="absolute inset-0 flex items-center justify-center text-xs font-bold">
                    ${diceCounts[num]} rolls
                  </div>
                </div>
              </div>
            `;
          }).join('');
          
          const robberDiceChart = Object.keys(robberDiceCounts).map(num => {
            const count = robberDiceCounts[num];
            const displayNum = num === '7' ? 'Desert' : num;
            return `
              <div class="mb-3">
                <div class="flex justify-between mb-1">
                  <span class="font-bold">${displayNum}</span>
                  <span class="text-sm text-red-400">${count} times</span>
                </div>
                <div class="relative h-6 bg-gray-700 rounded overflow-hidden">
                  <div class="absolute h-full bg-red-500" style="width: ${sevenCount > 0 ? (count / sevenCount * 100) : 0}%"></div>
                </div>
              </div>
            `;
          }).join('');
          
          content = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
              <div class="bg-gradient-to-br from-purple-600 to-purple-800 p-4 rounded-lg">
                <div class="text-sm opacity-80">Longest Streak (No Robber)</div>
                <div class="text-3xl font-bold">${longestStreak} rounds</div>
              </div>
              <div class="bg-gradient-to-br from-orange-600 to-orange-800 p-4 rounded-lg">
                <div class="text-sm opacity-80">Average Round Duration</div>
                <div class="text-3xl font-bold">${avgDuration}s</div>
              </div>
            </div>
            
            <div class="bg-gray-800 p-6 rounded-lg mb-6">
              <h3 class="text-xl font-bold mb-4">Dice Roll Probability Analysis</h3>
              <p class="text-sm text-gray-400 mb-4">Blue bars show actual rolls, gray bars show expected probability for fair 2d6 dice.</p>
              ${probabilityChart}
              <div class="mt-6 p-4 bg-red-900 bg-opacity-30 rounded border border-red-700">
                <div class="flex justify-between items-center">
                  <span class="font-bold text-red-300">Robber (7s only accepted from round ${state.robberStartRound})</span>
                  <span class="text-2xl font-bold text-red-400">${sevenCount} times</span>
                </div>
              </div>
            </div>
            
            <div class="bg-gray-800 p-6 rounded-lg">
              <h3 class="text-xl font-bold mb-4">Robber Dice Distribution</h3>
              <p class="text-sm text-gray-400 mb-4">When a 7 is rolled, this shows the distribution of the robber placement dice.</p>
              ${sevenCount > 0 ? robberDiceChart : '<p class="text-gray-500 text-center py-4">No robber activations yet</p>'}
            </div>
          `;
        }
        
        // SETTINGS VIEW
        else if (state.currentView === 'settings') {
          content = `
            <div class="space-y-6">
              <!-- Vibration -->
              <div class="bg-gray-800 p-6 rounded-lg" title="Enable or disable vibration alerts">
                <div class="flex justify-between items-center">
                  <div>
                    <h3 class="text-lg font-bold">Vibration</h3>
                    <p class="text-sm text-gray-400">Vibrate at 5 seconds remaining</p>
                  </div>
                  <button onclick="toggleSetting('vibrationEnabled')" 
                    class="px-6 py-3 rounded font-bold ${state.vibrationEnabled ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-600 hover:bg-gray-700'}">
                    ${state.vibrationEnabled ? 'ON' : 'OFF'}
                  </button>
                </div>
              </div>
              
              <!-- Flash Speed -->
              <div class="bg-gray-800 p-6 rounded-lg" title="Adjust how fast the warning flash alternates">
                <h3 class="text-lg font-bold mb-2">Flash Speed</h3>
                <p class="text-sm text-gray-400 mb-4">How fast the warning flash alternates (${state.flashSpeed}ms)</p>
                <div class="flex items-center gap-4">
                  <span class="text-sm">Slow</span>
                  <input type="range" min="300" max="1000" step="100" value="${state.flashSpeed}" 
                    oninput="updateSetting('flashSpeed', this.value)"
                    class="flex-1 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                  <span class="text-sm">Fast</span>
                </div>
                <div class="mt-2 text-center text-sm text-gray-400">
                  ${state.flashSpeed < 500 ? 'Very Fast' : state.flashSpeed < 700 ? 'Fast' : state.flashSpeed < 900 ? 'Normal' : 'Slow'}
                </div>
              </div>
              
              <!-- Robber Start Round -->
              <div class="bg-gray-800 p-6 rounded-lg" title="Set which round the robber becomes active">
                <h3 class="text-lg font-bold mb-2">Robber Activation Round</h3>
                <p class="text-sm text-gray-400 mb-4">Which round the robber becomes active (currently: ${state.robberStartRound})</p>
                <div class="flex items-center gap-4">
                  <button onclick="updateSetting('robberStartRound', ${Math.max(1, state.robberStartRound - 1)})"
                    class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded font-bold text-xl">‚àí</button>
                  <div class="flex-1 text-center">
                    <div class="text-4xl font-bold">${state.robberStartRound}</div>
                  </div>
                  <button onclick="updateSetting('robberStartRound', ${Math.min(99, state.robberStartRound + 1)})"
                    class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded font-bold text-xl">+</button>
                </div>
              </div>
            </div>
          `;
        }
        
        // INFO VIEW
        else if (state.currentView === 'info') {
          content = `
            <div class="space-y-6">
              <!-- Keyboard Shortcuts -->
              <div class="bg-gray-800 p-6 rounded-lg">
                <h3 class="text-xl font-bold mb-4">‚å®Ô∏è Keyboard Shortcuts</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <div class="flex justify-between items-centre bg-gray-700 px-4 py-2 rounded">
                    <span class="text-sm">Pause/Resume</span>
                    <kbd class="px-3 py-1 bg-gray-900 rounded font-mono text-xs">SPACE</kbd>
                  </div>
                  <div class="flex justify-between items-centre bg-gray-700 px-4 py-2 rounded">
                    <span class="text-sm">Next Round</span>
                    <kbd class="px-3 py-1 bg-gray-900 rounded font-mono text-xs">N</kbd>
                  </div>
                  <div class="flex justify-between items-centre bg-gray-700 px-4 py-2 rounded">
                    <span class="text-sm">Open Stats</span>
                    <kbd class="px-3 py-1 bg-gray-900 rounded font-mono text-xs">S</kbd>
                  </div>
                </div>
              </div>
              
              <!-- About -->
              <div class="bg-gray-800 p-6 rounded-lg">
                <h3 class="text-xl font-bold mb-4">‚ÑπÔ∏è About Catan Connect</h3>
                <p class="text-sm text-gray-300 mb-4">
                  A digital timer and dice roller for the mega game version of Catan known as <strong>Catan Connect</strong>. 
                  With multiple copies, this game can be played with an exponential number of people, although always at even numbers. 
                  Features automatic round progression, robber mechanics, statistics tracking, and customisable settings.
                </p>
                <p class="text-sm text-gray-300 mb-4">
                  <a href="https://boardgamegeek.com/boardgame/451387/catan-connect" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:text-blue-300 underline">
                    View Catan Connect on BoardGameGeek ‚Üí
                  </a>
                </p>
                <p class="text-xs text-gray-500">
                  Version 1.0 | Built with HTML, CSS & JavaScript
                </p>
              </div>
              
              <!-- Image -->
              <div class="bg-gray-800 p-6 rounded-lg text-centre">
                <img src="Catan_Connect_Front_v1.png" alt="Catan Connect" class="w-full max-w-md mx-auto rounded-lg shadow-lg" onerror="this.style.display='none'">
              </div>
              
              <!-- Teaching Script -->
              <div class="bg-gray-800 p-6 rounded-lg">
                <h3 class="text-xl font-bold mb-4">üìñ Teaching Script</h3>
                <div class="text-sm text-gray-300 space-y-3 max-h-96 overflow-y-auto">
                  <p class="font-bold text-lg">Welcome to Catan Connect</p>
                  
                  <p>In this fast-paced mega game of Catan you will be racing to 18 points.</p>
                  
                  <p>Each round I will announce whether the moon-side or the sun side is active, and from round 11 onwards whether the robber is robbing.</p>
                  
                  <p>Each round will go for 30 seconds, although I can lengthen this if needed.</p>
                  
                  <p>Every player starts with 1 of each of the resources matching the hexes surrounding their city, and 4 points ‚Äî 2 for their city and 2 for their two settlements.</p>
                  
                  <p>Each player starts on a region of their own, with a robber which can only be moved within your own region.</p>
                  
                  <p>Each time you build your first settlement into the region on your left or right you will gain 2 victory points, and you can mark that on your playmat.</p>
                  
                  <p class="font-bold">There are development tiles which can be purchased from either side of the game mat you are on. These include:</p>
                  
                  <ul class="list-disc list-inside space-y-2 ml-4">
                    <li><strong>Road Building (x1)</strong><br>When you play this tile, build 2 roads at no cost</li>
                    
                    <li><strong>Invention/Year of Plenty (x1)</strong><br>When you play this tile, take any 2 resources from the supply</li>
                    
                    <li><strong>Victory Point (x2)</strong><br>When you are the active player, you may reveal all your Victory Point tiles, including any purchased on that turn, if you can reach the number of VPs needed to win. Otherwise, keep Victory Point tiles face down in front of you</li>
                    
                    <li><strong>Knight (x5)</strong><br>When you play the Knight tile:<br>
                    Move the robber to the desert and take 1 resource corresponding to the hex where the robber was, OR;<br>
                    If the robber is already in the desert, it remains there and you may take 1 resource of your choice from the supply</li>
                  </ul>
                  
                  <p>If you and your direct opponent ever buy all the development tiles from your game mat, you may purchase them from a neighbour's supply.</p>
                  
                  <p>There should be banks of resources within everyone's reach. When a number is rolled that matches the number on a hex you built on, take the resource/s that matches (1 for a settlement and 2 for a city).</p>
                  
                  <p>If there are ever no resources available please throw your hand up so we can replenish the banks.</p>
                  
                  <p class="font-bold">A general turn goes like this:</p>
                  
                  <ol class="list-decimal list-inside space-y-2 ml-4">
                    <li>I will announce which side is active and what the dice roll is</li>
                    <li>All players will collect the resources as per the roll</li>
                    <li>All players can trade with the five people surrounding them</li>
                    <li>All players can trade at trading posts if they have built a settlement or a city there</li>
                    <li>If you are the active player and are at one of the ends you may also trade with the Market. At the market you may, once per turn, trade one resource for another resource at the market.</li>
                    <li>Active players can buy or build any roads, settlements, cities or development tiles</li>
                    <li>Active players can play 1 development tile which they have bought on a previous turn</li>
                    <li>The active player may reveal all their Victory Point tiles, including any purchased this turn, if they can reach the number of VPs needed to win</li>
                  </ol>
                  
                  <p class="font-bold">Sevens can only be rolled after the 11th round.</p>
                  
                  <p>When a robber is rolled you will need to move it to the number on your mat which corresponds with the number I give.</p>
                  
                  <p>The robber doesn't rob in this version of Catan. Instead its purpose is to block.</p>
                  
                  <p>You will have to halve your resource pool however if you have over 7 resources. This is rounded down, so if you have 9 resources you only have to get rid of 4.</p>
                  
                  <p class="font-bold">The competition of Longest Road and Largest Army is only between you and the person sharing your mat.</p>
                  
                  <p>For Longest Road you will need at least 5 of your roads connected, or, after that, more than the other player.</p>
                  
                  <p>For Largest Army you need to have played out at least 2 Knights, or, after that, more than the other player.</p>
                  
                  <p>If you gain either of these, mark the spot on your mat to claim it and move your point marker up 2 spaces.</p>
                  
                  <p>If your opponent takes this achievement from you, they will take your marker to mark on their side on the mat and you will need to put your point tracker down by 2 spaces.</p>
                  
                  <p>Because this is a fast paced game, mistakes will be made, and that is okay. Everyone will make a mistake at some point and the point is to have fun. If you ever need a moment to understand something though, please throw your hand up so I can pause the game.</p>
                  
                  <p class="font-bold text-lg">Does anyone have any questions?</p>
                </div>
              </div>
            </div>
          `;
        }

        app.innerHTML = `
          <div class="min-h-screen flex flex-col items-center justify-start bg-gray-900 text-white p-4 md:p-6" style="position: relative; z-index: 9999;">
            <div class="w-full max-w-4xl">
              <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                <h1 class="text-3xl md:text-4xl font-bold">Catan Connect</h1>
                <button onclick="closeStats()" class="px-4 py-2 bg-blue-600 rounded hover:bg-blue-700 text-sm md:text-base">
                  ‚Üê Back to Game
                </button>
              </div>
              
              ${tabs}
              ${content}
            </div>
          </div>
        `;
        return;
      }

      // Warning overlay with custom background
      if (state.showWarning) {
        app.innerHTML = `
          <div class="min-h-screen flex items-center justify-center bg-warning">
            <div class="text-center bg-black bg-opacity-50 p-12 rounded-lg">
              <div class="text-6xl font-bold text-white mb-4 animate-pulse">‚ö†Ô∏è WARNING ‚ö†Ô∏è</div>
              <div class="text-4xl font-bold text-white mb-2">ROBBER IS NOW ACTIVE</div>
              <div class="text-xl text-white mb-8">Rounds will be increased by 10 seconds</div>
              <button onclick="skipWarning()" class="px-8 py-4 bg-white text-2xl font-bold text-green-700 rounded-lg hover:bg-gray-100">
                SKIP
              </button>
            </div>
          </div>
        `;
        return;
      }

      // Countdown 3-2-1
      if (state.countdownPhase) {
        app.innerHTML = `
          <div class="min-h-screen flex flex-col items-center justify-center bg-gray-900">
            <div class="text-9xl font-bold text-white">${state.countdownValue}</div>
          </div>
        `;
        return;
      }

      // Start screen
      if (state.diceNumber === null) {
        app.innerHTML = `
          <div class="min-h-screen flex flex-col items-center justify-center bg-gradient-to-br from-orange-600 to-amber-700 gap-8 p-6">
            <h1 class="text-6xl font-bold text-white mb-4">Catan Connect</h1>
            
            <div class="flex items-center gap-4 bg-black bg-opacity-40 px-6 py-3 rounded-lg text-white">
              <button onclick="adjustRoundTime(-5)" class="text-3xl font-bold hover:text-gray-300 px-3">‚àí</button>
              <div class="text-2xl font-bold">${state.roundTime}s per round</div>
              <button onclick="adjustRoundTime(5)" class="text-3xl font-bold hover:text-gray-300 px-3">+</button>
            </div>

            <button onclick="handleStart()" class="px-12 py-6 bg-white text-4xl font-bold text-orange-700 rounded-lg hover:bg-gray-100">START GAME</button>
          </div>
        `;
        return;
      }

      // Main playing view
      const bgClass = state.round % 2 === 0 ? "bg-moon" : "bg-sun";
      const minutes = String(Math.floor(state.timeLeft / 60)).padStart(2,'0');
      const seconds = String(state.timeLeft % 60).padStart(2,'0');

      // Robber case - NO round number displayed
      if (state.diceNumber === 7 && state.round >= 11 && state.robberNumber !== null) {
        const robberDisplay = state.robberNumber === 'Desert' ? 'Desert' : state.robberNumber;
        app.innerHTML = `
          <div class="flex flex-col min-h-screen bg-warning text-white" style="position: relative;">
            <div style="position: relative; z-index: 10;">
              <div class="absolute top-4 md:top-8 left-4 md:left-8 flex items-center gap-2 md:gap-4 bg-black bg-opacity-40 px-3 md:px-6 py-2 md:py-3 rounded-lg text-sm md:text-base">
                <button onclick="adjustRoundTime(-5)" title="Decrease round time" class="text-xl md:text-3xl font-bold hover:text-gray-300 px-2 md:px-3">‚àí</button>
                <div class="text-lg md:text-2xl font-bold">${state.roundTime}s</div>
                <button onclick="adjustRoundTime(5)" title="Increase round time" class="text-xl md:text-3xl font-bold hover:text-gray-300 px-2 md:px-3">+</button>
                <div class="h-6 w-px bg-white opacity-30 mx-1 md:mx-2"></div>
                <button onclick="showStatsPrompt()" title="For stats, info, settings, or to start a new game" class="text-lg md:text-2xl font-bold hover:text-gray-300">‚öôÔ∏è</button>
              </div>

              <div class="flex-1 flex flex-col items-center justify-center px-4" style="min-height: 100vh;">
                <div class="flex flex-col items-center gap-4 md:gap-6 clamp-center">
                  <div class="robber-label font-bold text-center" style="font-size: clamp(4rem, 10vw, 7rem); line-height:1.2;">
                    ROBBER ON<br>${robberDisplay}
                  </div>
                  <div class="text-center" style="font-size: clamp(1.5rem, 4vw, 2.5rem); line-height:1.4; max-width: 90vw;">
                    If you have more than 7 resources,<br>discard half (rounded down)
                  </div>
                </div>

                <div class="timer-text font-mono font-bold mt-4 md:mt-8" style="font-size: clamp(3rem, 10vw, 7rem);">${minutes}:${seconds}</div>

                <div class="flex gap-4 md:gap-6 mt-4 md:mt-6">
                  <button onclick="togglePause()" title="${state.isPaused ? 'Resume timer' : 'Pause timer'}" class="p-4 md:p-6 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-full transition-all text-2xl md:text-4xl">${state.isPaused ? '‚ñ∂' : '‚è∏'}</button>
                  <button onclick="handleNext()" title="Skip to next round" class="p-4 md:p-6 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-full transition-all text-2xl md:text-4xl">‚è≠</button>
                </div>
              </div>
            </div>
          </div>
        `;
      } else {
        // Normal display with round number
        const activeLabel = (state.round % 2 === 0) ? "Moon Active" : "Sun Active";
        const activeLabelClass = (state.round % 2 === 0) ? "moon-active" : "sun-active";
        
        app.innerHTML = `
          <div class="flex flex-col min-h-screen ${bgClass} text-white" style="position: relative;">
            <div style="position: relative; z-index: 10;">
              <div class="absolute top-4 md:top-8 left-4 md:left-8 flex items-center gap-2 md:gap-4 bg-black bg-opacity-40 px-3 md:px-6 py-2 md:py-3 rounded-lg text-sm md:text-base">
                <button onclick="adjustRoundTime(-5)" title="Decrease round time" class="text-xl md:text-3xl font-bold hover:text-gray-300 px-2 md:px-3">‚àí</button>
                <div class="text-lg md:text-2xl font-bold" title="Current round time setting">${state.roundTime}s</div>
                <button onclick="adjustRoundTime(5)" title="Increase round time" class="text-xl md:text-3xl font-bold hover:text-gray-300 px-2 md:px-3">+</button>
                <div class="h-6 w-px bg-white opacity-30 mx-1 md:mx-2"></div>
                <div class="round-number text-lg md:text-2xl font-bold" title="Current round number">R${state.round}</div>
                <div class="h-6 w-px bg-white opacity-30 mx-1 md:mx-2"></div>
                <button onclick="showStatsPrompt()" title="For stats, info, settings, or to start a new game" class="text-lg md:text-2xl font-bold hover:text-gray-300">‚öôÔ∏è</button>
              </div>

              <div class="flex-1 flex flex-col items-center justify-center px-4" style="min-height: 100vh;">
                <div class="flex flex-col items-center gap-4 md:gap-8 clamp-center">
                  <div class="dice-circle" title="Current dice roll">
                    <div class="dice-number font-bold" style="font-size: clamp(10rem, 20vw, 15rem); line-height:1; position: absolute;">${state.diceNumber}</div>
                  </div>
                  <div class="${activeLabelClass} active-label font-bold" title="Current phase indicator" style="font-size: clamp(3rem, 8vw, 6rem);">${activeLabel}</div>
                  <div class="timer-text font-mono font-bold" title="Time remaining in round" style="font-size: clamp(3rem, 10vw, 7rem);">${minutes}:${seconds}</div>
                </div>

                <div class="flex gap-4 md:gap-6 mt-4 md:mt-6">
                  <button onclick="togglePause()" title="${state.isPaused ? 'Resume timer' : 'Pause timer'}" class="p-4 md:p-6 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-full transition-all text-2xl md:text-4xl">${state.isPaused ? '‚ñ∂' : '‚è∏'}</button>
                  <button onclick="handleNext()" title="Skip to next round" class="p-4 md:p-6 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-full transition-all text-2xl md:text-4xl">‚è≠</button>
                </div>
              </div>
            </div>
          </div>
        `;
      }
    }

    // Initial render
    render();
    
    // Load saved state
    loadState();
    render();
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Ignore if in stats view or modal
      if (state.showStats || state.showPauseModal) return;
      
      // Spacebar: Toggle pause
      if (e.code === 'Space') {
        e.preventDefault();
        if (state.diceNumber !== null && !state.countdownPhase && !state.showWarning) {
          togglePause();
        }
      }
      
      // N key: Next round
      if (e.code === 'KeyN') {
        e.preventDefault();
        if (state.diceNumber !== null && !state.countdownPhase && !state.showWarning) {
          handleNext();
        }
      }
      
      // S key: Stats
      if (e.code === 'KeyS') {
        e.preventDefault();
        if (state.diceNumber !== null && !state.countdownPhase && !state.showWarning) {
          showStatsPrompt();
        }
      }
    });
  </script>
  <script src="../menu.js"></script>
</body>
</html>