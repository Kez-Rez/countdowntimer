<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover" />
  <meta name="theme-color" content="#f59e0b" />
  <meta name="description" content="Official countdown timer for Catan Connect board game with dice rolling, round management, and statistics tracking" />
  <title>Catan Connect</title>

  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json" />

  <!-- App Icons -->
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png" />
  <link rel="apple-touch-icon" href="icon-192.png" />

  <!-- Tailwind CSS - Local fallback for offline use -->
  <script src="tailwind.standalone.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Service Worker Registration & PWA Support -->
  <script>
    // Register service worker for PWA functionality
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then(registration => {
            console.log('Service Worker registered successfully:', registration.scope);
          })
          .catch(error => {
            console.log('Service Worker registration failed:', error);
          });
      });
    }

    // PWA Install Prompt
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      // Show install button
      const installBtn = document.getElementById('pwa-install-btn');
      if (installBtn) {
        installBtn.style.display = 'block';
      }
    });

    // Handle PWA install
    function installPWA() {
      const installBtn = document.getElementById('pwa-install-btn');
      if (!deferredPrompt) {
        return;
      }
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then((choiceResult) => {
        if (choiceResult.outcome === 'accepted') {
          console.log('User accepted the install prompt');
        }
        deferredPrompt = null;
        if (installBtn) {
          installBtn.style.display = 'none';
        }
      });
    }

    // Offline detection and graceful fallback
    window.addEventListener('load', () => {
      // Check if Tailwind loaded properly
      setTimeout(() => {
        const testElement = document.createElement('div');
        testElement.className = 'bg-blue-500';
        document.body.appendChild(testElement);
        const hasColor = window.getComputedStyle(testElement).backgroundColor === 'rgb(59, 130, 246)';
        document.body.removeChild(testElement);

        if (!hasColor && !window.tailwindCSSLoaded) {
          console.warn('Tailwind CSS failed to load - using local fallback');
        }
      }, 100);
    });
  </script>
  <style>
    html, body { 
      height: 100%; 
      margin: 0; 
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      overflow: hidden;
    }
    body {
      min-height: -webkit-fill-available;
    }
    
    /* ========== EASY COLOR CUSTOMIZATION ========== */
    :root {
      --color-dice-number: #ffffff;
      --color-sun-active: #ffffff;
      --color-moon-active: #ffffff;
      --color-robber-label: #ffffff;
      --color-robber-number: #ffffff;
      --color-timer: #ffffff;
      --color-round-number: #ffffff;
    }
    
    .dice-number { color: var(--color-dice-number); }
    .sun-active { color: var(--color-sun-active); }
    .moon-active { color: var(--color-moon-active); }
    .robber-label { color: var(--color-robber-label); }
    .robber-number { color: var(--color-robber-number); }
    .timer-text { color: var(--color-timer); }
    .round-number { color: var(--color-round-number); }
    /* ============================================== */
    
    /* Background images */
    .bg-sun {
      /* Sun/Orange background - burnt orange */
      background: linear-gradient(135deg, #cc5500 0%, #ff6600 50%, #cc5500 100%);
      background-size: cover;
      background-position: center;
    }
    
    .bg-moon {
      /* Moon/Blue background - navy blue */
      background: linear-gradient(135deg, #001f3f 0%, #003366 50%, #001f3f 100%);
      background-size: cover;
      background-position: center;
    }
    
    .bg-flash {
      /* Not used - text flashes instead */
      display: none;
    }
    
    .flash-red {
      color: #ff0000 !important;
      transition: color 0.3s ease-in-out;
    }
    
    .flash-custom {
      transition: color 0.3s ease-in-out;
    }
    
    .flash-fullscreen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      z-index: 9998;
      transition: opacity 0.3s ease-in-out;
    }
    
    .bg-warning {
      /* Robber warning background - forest green */
      background: linear-gradient(135deg, #0d4d0d 0%, #1a661a 50%, #0d4d0d 100%);
      background-size: cover;
      background-position: center;
    }
    
    /* Band for dice number and active status */
    .shaded-rectangle {
      width: 100vw;
      margin-left: calc(-50vw + 50%);
      margin-right: calc(-50vw + 50%);
      min-height: min(220px, 35vh);
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border-top: 4px solid rgba(255, 255, 255, 0.4);
      border-bottom: 4px solid rgba(255, 255, 255, 0.4);
      position: relative;
      padding: 1rem 0;
      gap: 0.5rem;
    }

    .dice-number {
      font-size: min(18rem, 36vw) !important;
      line-height: 1 !important;
      transform: none;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      margin-bottom: 0.1em;
    }

    .active-label {
      margin-top: -1rem;
    }
    
    /* Responsive font sizes */
    @media (max-width: 768px) {
      .dice-number { font-size: 10rem !important; }
      .robber-number { font-size: 10rem !important; }
      .robber-label { font-size: 6rem !important; }
      .active-label { font-size: 4rem !important; }
      .timer-text { font-size: 4rem !important; }
    }
    
    @media (max-width: 480px) {
      .dice-number { font-size: 7rem !important; }
      .robber-number { font-size: 7rem !important; }
      .robber-label { font-size: 4rem !important; }
      .active-label { font-size: 2.5rem !important; }
      .timer-text { font-size: 3rem !important; }
    }

    /* Specific landscape mode adjustments for 1280x800 and similar resolutions */
    @media (orientation: landscape) and (min-width: 1024px) and (max-height: 900px) {
      .shaded-rectangle {
        width: 100% !important;
        min-height: min(150px, 40vh) !important;
        border-width: 4px !important;
        padding: 0.25rem 0 !important;
      }
      .dice-number { 
        font-size: min(14.4rem, 25vh) !important;
        transform: none !important;
      }
      .robber-number { 
        font-size: min(14.4rem, 25vh) !important;
        transform: none !important;
      }
      .robber-label { 
        font-size: 2.8rem !important;
        line-height: 1.1 !important;
      }
      .active-label { 
        font-size: 2.2rem !important;
        margin: 0.5rem 0 !important;
      }
      .timer-text { 
        font-size: 2.8rem !important;
        margin: 0.5rem 0 !important;
      }
      .flex-col { 
        gap: 0.75rem !important; 
      }
      [class*="mt-"], [class*="mb-"], [class*="my-"] {
        margin-top: 0.5rem !important;
        margin-bottom: 0.5rem !important;
      }
      [class*="gap-"] {
        gap: 0.75rem !important;
      }
      .min-h-screen {
        min-height: 100vh !important;
        height: 100vh !important;
        overflow: hidden !important;
      }
    }
    
    .clamp-center { display:flex; align-items:center; justify-content:center; }
    
    /* Modal styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
    // Game Configuration Constants
    const GAME_CONFIG = {
      DEFAULT_ROUND_TIME: 30,
      ROBBER_START_ROUND: 11,
      ROBBER_TIME_BONUS: 10,
      COUNTDOWN_START: 3,
      WARNING_FLASH_THRESHOLD: 5,
      MIN_ROUND_TIME: 10,
      MAX_ROUND_TIME: 120,
      VIBRATION_PATTERN: [200, 100, 200],
      FLASH_SPEEDS: {
        MIN: 300,
        MAX: 1000,
        STEP: 100
      }
    };

    // UI Constants
    const UI_CONSTANTS = {
      COLORS: {
        FLASH_RED: '#ff0000',
        WARNING_GREEN: '#0d4d0d'
      },
      CSS_CLASSES: {
        CARD: 'bg-gray-800 p-6 rounded-lg',
        CARD_HEADER: 'bg-gray-700 p-1 rounded-lg',
        BUTTON_PRIMARY: 'px-6 py-3 bg-blue-600 rounded hover:bg-blue-700 font-bold',
        BUTTON_SUCCESS: 'px-6 py-3 bg-green-600 rounded hover:bg-green-700 font-bold',
        BUTTON_DANGER: 'px-6 py-3 bg-red-600 rounded hover:bg-red-700 font-bold',
        CHECKBOX: 'w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded',
        CHECKBOX_LARGE: 'w-5 h-5 text-red-600 bg-gray-700 border-gray-600 rounded',
        LABEL: 'flex items-center gap-3 cursor-pointer'
      }
    };

    // State Defaults Configuration
    const STATE_DEFAULTS = {
      vibrationEnabled: true,
      vibrate10sec: false,
      vibrate5sec: true,
      vibrate3sec: false,
      vibrate1sec: false,
      flashSpeed: 600,
      flashTextEnabled: true,
      flashFullscreenEnabled: false,
      flashColor: UI_CONSTANTS.COLORS.FLASH_RED,
      flashOpacity: 40,
      flashThreshold: GAME_CONFIG.WARNING_FLASH_THRESHOLD,
      robberStartRound: GAME_CONFIG.ROBBER_START_ROUND,
      chimeEnabled: true,
      chimeVolume: 50,
      chime10sec: false,
      chime5sec: true,
      chime3sec: false,
      chime1sec: false,
      currentView: 'stats',
      wasRunningBeforeMenu: false
    };

    // State
    let state = {
      round: 1,
      roundTime: GAME_CONFIG.DEFAULT_ROUND_TIME,
      timeLeft: GAME_CONFIG.DEFAULT_ROUND_TIME,
      isPaused: true,
      diceNumber: null,
      robberNumber: null,
      showWarning: false,
      countdownPhase: false,
      countdownValue: GAME_CONFIG.COUNTDOWN_START,
      showStats: false,
      roundLog: [], // {round, dice, robber, duration}
      currentCountdownInterval: null,
      showPauseModal: false,
      // Settings
      vibrationEnabled: true,
      vibrate10sec: false,
      vibrate5sec: true,
      vibrate3sec: false,
      vibrate1sec: false,
      flashSpeed: 600,
      flashTextEnabled: true, // Text flash (always red)
      flashFullscreenEnabled: false, // Fullscreen flash (custom colour)
      flashColor: '#ff0000',
      flashOpacity: 40, // 0-100 for fullscreen flash opacity
      flashThreshold: GAME_CONFIG.WARNING_FLASH_THRESHOLD,
      robberStartRound: GAME_CONFIG.ROBBER_START_ROUND,
      chimeEnabled: true,
      chimeVolume: 50,
      chime10sec: false,
      chime5sec: true,
      chime3sec: false,
      chime1sec: false,
      currentView: 'stats', // 'stats', 'settings', 'info', 'advanced'
      roundStartTime: null,
      wasRunningBeforeMenu: false // Track if timer was running before opening menu
    };

    let intervalTimer = null;
    let intervalFlash = null;
    let flashState = false;
    let chimeAudio = null;

    // =============================================================================
    // UTILITY FUNCTIONS
    // =============================================================================

    // Generic error handling utility
    function safeExecute(fn, errorMsg) {
      try {
        return fn();
      } catch(e) {
        console.log(errorMsg, e);
        return null;
      }
    }

    // Generic timing check utility
    function shouldTriggerAtTime(timeLeft, featureType) {
      const enabledKey = `${featureType}Enabled`;
      if (!state[enabledKey]) return false;
      
      const timings = [
        { seconds: 10, key: '10sec' },
        { seconds: 5, key: '5sec' },
        { seconds: 3, key: '3sec' },
        { seconds: 1, key: '1sec' }
      ];
      
      return timings.some(timing => {
        return timeLeft === timing.seconds && state[`${featureType}${timing.key}`];
      });
    }

    // Flash element utilities
    function getFlashElements() {
      return {
        diceNum: document.querySelector('.dice-number'),
        timer: document.querySelector('.timer-text'),
        activeLabel: document.querySelector('.active-label')
      };
    }

    function applyFlashToElements(elements, isFlashing) {
      Object.values(elements).forEach(element => {
        if (!element) return;
        if (isFlashing) {
          element.classList.add('flash-custom');
          element.style.color = UI_CONSTANTS.COLORS.FLASH_RED;
        } else {
          element.classList.remove('flash-custom', 'flash-red');
          element.style.color = '';
        }
      });
    }

    // HTML template helpers
    function createButton({ onclick, title, text, classes = UI_CONSTANTS.CSS_CLASSES.BUTTON_PRIMARY, icon = '' }) {
      return `
        <button onclick="${onclick}" title="${title}" class="${classes}">
          ${icon} ${text}
        </button>
      `;
    }

    function createCheckbox(settingKey, label, classes = UI_CONSTANTS.CSS_CLASSES.CHECKBOX) {
      return `
        <label class="${UI_CONSTANTS.CSS_CLASSES.LABEL}">
          <input type="checkbox" ${state[settingKey] ? 'checked' : ''} 
            onchange="toggleSetting('${settingKey}')" 
            class="${classes}">
          <span class="text-white">${label}</span>
        </label>
      `;
    }

    function createTimingCheckboxes(featureType, timings) {
      return timings.map(({key, label}) => 
        createCheckbox(`${featureType}${key}`, label)
      ).join('');
    }

    // State management utilities
    function loadStateProperty(parsed, key, defaultValue = STATE_DEFAULTS[key]) {
      return parsed[key] !== undefined ? parsed[key] : defaultValue;
    }

    // Update just the timer display in stats menu without full render
    function updateMenuTimerDisplay() {
      if (!state.showStats || state.diceNumber === null) return;
      
      const timerElement = document.querySelector('[data-menu-timer]');
      if (timerElement) {
        const minutes = Math.floor(state.timeLeft / 60);
        const seconds = String(state.timeLeft % 60).padStart(2, '0');
        const isWarning = state.timeLeft <= 5;
        
        timerElement.innerHTML = `
          <span class="font-bold text-yellow-300">Round ${state.round}</span> ‚Ä¢ 
          <span class="font-mono font-bold ${isWarning ? 'text-red-400' : 'text-white'}">${minutes}:${seconds}</span> 
          <span class="text-gray-400">${state.isPaused ? '(PAUSED)' : 'remaining'}</span>
        `;
      }
    }

    // Initialize chime audio with error handling
    function initChime() {
      if (!chimeAudio) {
        chimeAudio = new Audio('ding-sfx-330333_by_kakaist.mp3');
        chimeAudio.preload = 'auto';
        chimeAudio.onerror = (e) => {
          console.warn('Could not load chime audio:', e);
          // Gracefully disable chime functionality if audio fails
          state.chimeEnabled = false;
        };
        chimeAudio.oncanplaythrough = () => {
          console.log('Chime audio loaded successfully');
        };
      }
      chimeAudio.volume = state.chimeVolume / 100;
    }

    // Check if vibration should trigger at current time
    function shouldVibrate(timeLeft) {
      return shouldTriggerAtTime(timeLeft, 'vibration');
    }

    // Check if chime should play at current time
    function shouldChime(timeLeft) {
      return shouldTriggerAtTime(timeLeft, 'chime');
    }

    // Play chime sound
    function playChime() {
      if (!chimeAudio) initChime();
      safeExecute(() => {
        chimeAudio.currentTime = 0;
        chimeAudio.play().catch(e => console.log('Chime play failed:', e));
      }, 'Chime error:');
    }

    // Test vibration
    function testVibration() {
      if (navigator.vibrate && state.vibrationEnabled) {
        safeExecute(
          () => navigator.vibrate(GAME_CONFIG.VIBRATION_PATTERN),
          'Vibration test failed:'
        );
      }
    }

    // Toggle fullscreen mode
    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
      } else {
        document.exitFullscreen();
      }
    }

    // Load saved state on page load
    function loadState() {
      const saved = localStorage.getItem('catanTimerState');
      if (!saved) return;

      safeExecute(() => {
        const parsed = JSON.parse(saved);
        
        // Restore core game state
        state.round = parsed.round || 1;
        state.roundTime = parsed.roundTime || GAME_CONFIG.DEFAULT_ROUND_TIME;
        state.roundLog = parsed.roundLog || [];
        state.diceNumber = parsed.diceNumber || null;
        state.robberNumber = parsed.robberNumber || null;
        state.timeLeft = parsed.timeLeft || state.roundTime;

        // Load all settings using utility function
        Object.keys(STATE_DEFAULTS).forEach(key => {
          state[key] = loadStateProperty(parsed, key);
        });

        // Handle backwards compatibility for old flashType
        if (parsed.flashType !== undefined) {
          if (parsed.flashType === 'text') {
            state.flashTextEnabled = true;
            state.flashFullscreenEnabled = false;
          } else if (parsed.flashType === 'fullscreen') {
            state.flashTextEnabled = false;
            state.flashFullscreenEnabled = true;
          }
        }

        // Always start paused after reload
        state.isPaused = true;
      }, 'Failed to load saved state:');
    }

    // Save state to localStorage
    function saveState() {
      safeExecute(() => {
        const toSave = {
          // Core game state
          round: state.round,
          roundTime: state.roundTime,
          timeLeft: state.timeLeft,
          diceNumber: state.diceNumber,
          robberNumber: state.robberNumber,
          roundLog: state.roundLog
        };

        // Add all settings from STATE_DEFAULTS
        Object.keys(STATE_DEFAULTS).forEach(key => {
          toSave[key] = state[key];
        });

        localStorage.setItem('catanTimerState', JSON.stringify(toSave));
      }, 'Failed to save state:');
    }

    // Dice utilities - VERIFIED CORRECT
    // This simulates rolling 2d6 and adding them together
    function rollDice() {
      const d1 = Math.floor(Math.random()*6) + 1; // 1-6
      const d2 = Math.floor(Math.random()*6) + 1; // 1-6
      return d1 + d2; // 2-12
    }
    
    // Get random number, optionally excluding 7
    function getRandomNumber(excludeSeven=false) {
      let r = rollDice();
      if (excludeSeven) {
        while (r === 7) r = rollDice();
      }
      return r;
    }
    
    /* MATH VERIFICATION:
     * - rollDice() generates 1-6 for each die, then adds them = 2-12 range ‚úì
     * - Before round 11: getRandomNumber(true) excludes 7s ‚úì
     * - Round 11+: getRandomNumber(false) allows 7s ‚úì
     * - When 7 is rolled: robberNumber gets a separate rollDice() call ‚úì
     * This correctly simulates Catan dice mechanics!
     */

    // Log a round
    function logRound(dice, robber) {
      const duration = state.roundStartTime ? Math.round((Date.now() - state.roundStartTime) / 1000) : state.roundTime;
      state.roundLog.push({
        round: state.round,
        dice: dice,
        robber: robber,
        duration: duration
      });
      state.roundStartTime = Date.now();
    }

    // Start a new round
    function startNewRound() {
      const robberPossible = state.round >= state.robberStartRound;
      let newDice;
      if (robberPossible) {
        newDice = getRandomNumber(false); // Allow 7s
        if (newDice === 7) {
          state.robberNumber = rollDice();
          // Handle desert case
          if (state.robberNumber === 7) {
            state.robberNumber = 'Desert';
          }
          logRound(newDice, state.robberNumber);
        } else {
          state.robberNumber = null;
          logRound(newDice, null);
        }
      } else {
        newDice = getRandomNumber(true); // Exclude 7s
        state.robberNumber = null;
        logRound(newDice, null);
      }
      state.diceNumber = newDice;
      
      // Increase round time by bonus seconds from robber start round onwards
      if (state.round >= GAME_CONFIG.ROBBER_START_ROUND) {
        state.timeLeft = state.roundTime + GAME_CONFIG.ROBBER_TIME_BONUS;
      } else {
        state.timeLeft = state.roundTime;
      }
      
      state.showWarning = false;
      saveState();
      render();
    }

    function startTimer() {
      stopTimerAndFlash();
      if (!state.isPaused && !state.countdownPhase && !state.showWarning) {
        intervalTimer = setInterval(() => {
          if (state.timeLeft <= 1) {
            handleNext();
          } else {
            state.timeLeft--;
            if (shouldVibrate(state.timeLeft) && navigator.vibrate) {
              try { navigator.vibrate(GAME_CONFIG.VIBRATION_PATTERN); } catch(e){}
            }
            if (shouldChime(state.timeLeft)) {
              playChime();
            }
            saveState();
            // Only render if not in stats menu to prevent scroll jumping
            if (!state.showStats) {
              render();
            } else {
              // Update just the timer display in the menu
              updateMenuTimerDisplay();
            }
          }
        }, 1000);

        // Flash warning when <= threshold seconds
        intervalFlash = setInterval(() => {
          const shouldFlash = (state.timeLeft <= state.flashThreshold && state.timeLeft > 0 && !state.isPaused && !state.countdownPhase && !state.showWarning);
          if (shouldFlash) {
            flashState = !flashState;
            
            // Fullscreen flash (if enabled)
            if (state.flashFullscreenEnabled) {
              let flashOverlay = document.getElementById('flash-overlay');
              if (!flashOverlay) {
                flashOverlay = document.createElement('div');
                flashOverlay.id = 'flash-overlay';
                flashOverlay.className = 'flash-fullscreen';
                document.body.appendChild(flashOverlay);
              }
              
              if (flashState) {
                flashOverlay.style.backgroundColor = state.flashColor;
                flashOverlay.style.opacity = (state.flashOpacity / 100).toString();
              } else {
                flashOverlay.style.opacity = '0';
              }
            }
            
            // Text flash (if enabled) - always red
            if (state.flashTextEnabled) {
              const elements = getFlashElements();
              applyFlashToElements(elements, flashState);
            }
          } else {
            // Clear all flashing
            const flashOverlay = document.getElementById('flash-overlay');
            if (flashOverlay) {
              flashOverlay.style.opacity = '0';
            }
            
            const diceNum = document.querySelector('.dice-number');
            const timer = document.querySelector('.timer-text');
            const activeLabel = document.querySelector('.active-label');
            if (diceNum) {
              diceNum.classList.remove('flash-custom', 'flash-red');
              diceNum.style.color = '';
            }
            if (timer) {
              timer.classList.remove('flash-custom', 'flash-red');
              timer.style.color = '';
            }
            if (activeLabel) {
              activeLabel.classList.remove('flash-custom', 'flash-red');
              activeLabel.style.color = '';
            }
          }
        }, state.flashSpeed);
      }
    }

    function stopTimerAndFlash() {
      if (intervalTimer) { clearInterval(intervalTimer); intervalTimer = null; }
      if (intervalFlash) { clearInterval(intervalFlash); intervalFlash = null; }
      
      // Clear fullscreen flash
      const flashOverlay = document.getElementById('flash-overlay');
      if (flashOverlay) {
        flashOverlay.style.opacity = '0';
      }
      
      // Clear text flash
      const elements = getFlashElements();
      applyFlashToElements(elements, false);
      flashState = false;
    }

    function stopFlashOnly() {
      if (intervalFlash) { clearInterval(intervalFlash); intervalFlash = null; }
      
      // Clear fullscreen flash
      const flashOverlay = document.getElementById('flash-overlay');
      if (flashOverlay) {
        flashOverlay.style.opacity = '0';
      }
      
      // Clear text flash
      const elements = getFlashElements();
      applyFlashToElements(elements, false);
      flashState = false;
    }

    function handleNext() {
      if (state.currentCountdownInterval) {
        clearInterval(state.currentCountdownInterval);
        state.currentCountdownInterval = null;
      }
      
      state.countdownPhase = true;
      state.countdownValue = GAME_CONFIG.COUNTDOWN_START;
      // Don't set isPaused during countdown - it's just transitioning
      stopTimerAndFlash();
      render();

      const countdownInterval = setInterval(() => {
        if (state.countdownValue > 1) {
          state.countdownValue--;
          render();
        } else {
          clearInterval(countdownInterval);
          state.countdownPhase = false;

          // Only increment round for non-robber rounds (robber is between rounds)
          if (state.robberNumber === null) state.round++;

          if (state.robberNumber === null && state.round === GAME_CONFIG.ROBBER_START_ROUND) {
            state.showWarning = true;
            render();
            // User must manually skip warning screen
          } else {
            startNewRound();
            state.isPaused = false;
            startTimer();
          }
        }
      }, 1000);
      
      state.currentCountdownInterval = countdownInterval;
    }

    function togglePause() {
      state.isPaused = !state.isPaused;
      if (state.isPaused) {
        stopTimerAndFlash();
      } else {
        startTimer();
      }
      render();
    }
    
    function skipWarning() {
      state.showWarning = false;
      startNewRound();
      state.isPaused = false;
      startTimer();
    }

    function handleStart() {
      startNewRound();
      state.isPaused = false;
      startTimer();
    }
    
    function handleContinueGame() {
      // Continue from current state (if diceNumber exists, resume game)
      if (state.diceNumber !== null) {
        // Apply current round time setting from landing page to continued game
        state.timeLeft = state.roundTime;
        state.isPaused = false;
        startTimer();
      } else {
        // If no saved game, start new
        handleStart();
      }
    }
    
    function confirmNewGame() {
      if (confirm('Are you sure you want to start a new game? This will reset all progress and clear statistics.')) {
        // Clear everything for a fresh start (but keep current round time setting from landing page)
        const currentRoundTime = state.roundTime;  // Preserve landing page setting
        state.round = 1;
        state.roundTime = currentRoundTime;
        state.timeLeft = currentRoundTime;
        state.isPaused = true;
        state.diceNumber = null;
        state.robberNumber = null;
        state.showWarning = false;
        state.countdownPhase = false;
        state.roundLog = [];
        state.roundStartTime = null;
        
        // Clear saved state completely
        localStorage.removeItem('catanTimerState');
        saveState();
        
        // Start new game
        handleStart();
      }
    }

    function adjustRoundTime(delta) {
      state.roundTime = Math.max(GAME_CONFIG.MIN_ROUND_TIME, Math.min(GAME_CONFIG.MAX_ROUND_TIME, state.roundTime + delta));
      saveState();
      render();
    }

    function showStatsPrompt() {
      // Track if timer was running before opening menu
      state.wasRunningBeforeMenu = !state.isPaused;
      
      // Stop any flashing when opening settings, but keep timer running
      stopFlashOnly();
      
      // If already paused, skip the dialog
      if (state.isPaused) {
        state.showStats = true;
        render();
      } else {
        state.showPauseModal = true;
        render();
      }
    }

    function handleStatsChoice(shouldPause) {
      state.showPauseModal = false;
      if (shouldPause && !state.isPaused) {
        togglePause();
      }
      state.showStats = true;
      render();
    }

    function closeStats() {
      state.showStats = false;
      
      // If timer was running before menu and user didn't pause it, resume it
      if (state.wasRunningBeforeMenu && !state.isPaused && state.diceNumber !== null && !state.countdownPhase && !state.showWarning) {
        startTimer();
      }
      
      render();
    }
    
    function showNewGameConfirm() {
      // Save current game state and go to landing page
      saveState();
      
      // Stop all timers but don't clear data
      stopTimerAndFlash();
      if (state.currentCountdownInterval) {
        clearInterval(state.currentCountdownInterval);
        state.currentCountdownInterval = null;
      }
      
      // Set to show landing page (diceNumber = null triggers start screen)
      state.diceNumber = null;
      state.isPaused = true;
      state.showStats = false;
      render();
    }
    
    function changeView(view) {
      state.currentView = view;
      render();
    }
    
    function toggleSetting(setting) {
      state[setting] = !state[setting];
      saveState();
      render();
    }
    
    function updateSetting(setting, value) {
      // Handle different value types
      if (setting === 'flashColor') {
        state[setting] = value;
      } else {
        state[setting] = parseInt(value);
      }
      
      // Update chime volume immediately
      if (setting === 'chimeVolume' && chimeAudio) {
        chimeAudio.volume = value / 100;
      }
      
      saveState();
      
      // If changing flash settings while game is running, restart timer
      if ((setting === 'flashSpeed' || setting === 'flashTextEnabled' || setting === 'flashFullscreenEnabled' || setting === 'flashColor' || setting === 'flashOpacity' || setting === 'flashThreshold') && !state.isPaused) {
        startTimer();
      }
      
      render();
    }

    function copyStats() {
      const text = state.roundLog.map(log => 
        `Round ${log.round}: Dice ${log.dice}${log.robber ? ` (Robber: ${log.robber})` : ''} - ${log.duration}s`
      ).join('\n');
      navigator.clipboard.writeText(text).then(() => {
        alert('Stats copied to clipboard!');
      });
    }

    function exportStatsCSV() {
      const headers = 'Round,Dice Roll,Robber Number,Duration (seconds)\n';
      const rows = state.roundLog.map(log => 
        `${log.round},${log.dice},${log.robber || ''},${log.duration}`
      ).join('\n');
      
      const csv = headers + rows;
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `catan-game-stats-${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      window.URL.revokeObjectURL(url);
    }

    // =============================================================================
    // RENDER FUNCTIONS
    // =============================================================================

    function renderPauseModal() {
      const app = document.getElementById('app');
      
      if (state.isPaused) {
        app.innerHTML = `
          <div class="modal-overlay">
            <div class="${UI_CONSTANTS.CSS_CLASSES.CARD} text-white text-center max-w-md">
              <h2 class="text-2xl font-bold mb-4">Timer is Paused</h2>
              <p class="mb-6">The timer is currently paused. Continue to view settings & statistics.</p>
              <div class="flex gap-4 justify-center">
                ${createButton({ 
                  onclick: "handleStatsChoice(false)", 
                  title: "Continue to menu", 
                  text: "Continue",
                  classes: UI_CONSTANTS.CSS_CLASSES.BUTTON_SUCCESS
                })}
              </div>
            </div>
          </div>
        `;
      } else {
        app.innerHTML = `
          <div class="modal-overlay">
            <div class="${UI_CONSTANTS.CSS_CLASSES.CARD} text-white text-center max-w-md">
              <h2 class="text-2xl font-bold mb-4">View Settings & Statistics</h2>
              <p class="mb-6">Would you like to pause the game?</p>
              <div class="flex gap-4 justify-center">
                ${createButton({ 
                  onclick: "handleStatsChoice(true)", 
                  title: "Pause and open menu", 
                  text: "Yes, Pause",
                  classes: UI_CONSTANTS.CSS_CLASSES.BUTTON_PRIMARY
                })}
                ${createButton({ 
                  onclick: "handleStatsChoice(false)", 
                  title: "Continue without pausing", 
                  text: "No, Continue",
                  classes: UI_CONSTANTS.CSS_CLASSES.BUTTON_SUCCESS
                })}
              </div>
            </div>
          </div>
        `;
      }
    }

    function renderStatsView() {
      const app = document.getElementById('app');
      
      // Navigation tabs
      const tabs = `
        <div class="flex gap-2 mb-6 overflow-x-auto flex-wrap">
          ${createButton({ 
            onclick: "changeView('stats')", 
            title: "Stats: View game statistics and round history", 
            text: "üìä Stats",
            classes: `px-4 py-2 rounded font-bold ${state.currentView === 'stats' ? 'bg-blue-600' : 'bg-gray-700 hover:bg-gray-600'}`
          })}
          ${createButton({ 
            onclick: "changeView('advanced')", 
            title: "Advanced: View dice probability analysis and advanced metrics", 
            text: "üìà Advanced",
            classes: `px-4 py-2 rounded font-bold ${state.currentView === 'advanced' ? 'bg-blue-600' : 'bg-gray-700 hover:bg-gray-600'}`
          })}
          ${createButton({ 
            onclick: "changeView('settings')", 
            title: "Settings: Configure game settings and preferences", 
            text: "‚öôÔ∏è Settings",
            classes: `px-4 py-2 rounded font-bold ${state.currentView === 'settings' ? 'bg-blue-600' : 'bg-gray-700 hover:bg-gray-600'}`
          })}
          ${createButton({ 
            onclick: "changeView('info')", 
            title: "Info: View keyboard shortcuts, rules, and about information", 
            text: "‚ÑπÔ∏è Info",
            classes: `px-4 py-2 rounded font-bold ${state.currentView === 'info' ? 'bg-blue-600' : 'bg-gray-700 hover:bg-gray-600'}`
          })}
          ${createButton({ 
            onclick: "showNewGameConfirm()", 
            title: "Start Screen: Go to start screen to begin a new game", 
            text: "üè† Start Screen",
            classes: "px-4 py-2 rounded font-bold bg-orange-600 hover:bg-orange-700"
          })}
        </div>
      `;
      
      // Get content based on current view
      let content = '';
      if (state.currentView === 'stats') {
        content = renderStatsContent();
      } else if (state.currentView === 'advanced') {
        content = renderAdvancedStatsContent();
      } else if (state.currentView === 'settings') {
        content = renderSettingsContent();
      } else if (state.currentView === 'info') {
        content = renderInfoContent();
      }

      // Store current scroll position before render
      const scrollContainer = document.querySelector('.overflow-y-auto');
      const scrollTop = scrollContainer ? scrollContainer.scrollTop : 0;
      
      app.innerHTML = `
        <div class="min-h-screen max-h-screen flex flex-col items-center justify-start bg-gray-900 text-white overflow-hidden" style="position: relative; z-index: 9999;">
          <div class="flex-shrink-0 p-4 md:p-6 w-full max-w-4xl">
            <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
              <div class="flex flex-col">
                <h1 class="text-3xl md:text-4xl font-bold">Catan Connect</h1>
                ${state.diceNumber !== null ? `
                  <div class="flex items-center gap-3 mt-1">
                    <div class="text-lg text-gray-300" style="font-size: 1.4em;" data-menu-timer>
                      <span class="font-bold text-yellow-300">Round ${state.round}</span> ‚Ä¢ 
                      <span class="font-mono font-bold ${state.timeLeft <= 5 ? 'text-red-400' : 'text-white'}">${Math.floor(state.timeLeft / 60)}:${String(state.timeLeft % 60).padStart(2,'0')}</span> 
                      <span class="text-gray-400">${state.isPaused ? '(PAUSED)' : 'remaining'}</span>
                    </div>
                    ${createButton({ 
                      onclick: "togglePause()", 
                      title: `${state.isPaused ? 'Resume: Resume timer' : 'Pause: Pause timer'}`, 
                      text: state.isPaused ? '‚ñ∂' : '‚è∏',
                      classes: "text-xl px-2 py-1 bg-white bg-opacity-20 hover:bg-opacity-30 rounded transition-all"
                    })}
                  </div>
                ` : ''}
              </div>
              ${createButton({ 
                onclick: "closeStats()", 
                title: "Back to Game: Return to the main game screen", 
                text: "‚Üê Back to Game",
                classes: "px-6 py-3 bg-blue-600 rounded hover:bg-blue-700 text-base md:text-lg font-bold"
              })}
            </div>
            ${tabs}
          </div>
          <div class="flex-1 overflow-y-auto px-4 md:p-6 pb-4 md:pb-6 w-full" id="statsScrollContainer">
            <div class="w-full max-w-4xl mx-auto">
              ${content}
            </div>
          </div>
        </div>
      `;
      
      // Restore scroll position after render
      setTimeout(() => {
        const newScrollContainer = document.getElementById('statsScrollContainer');
        if (newScrollContainer && scrollTop > 0) {
          newScrollContainer.scrollTop = scrollTop;
        }
      }, 0);
    }

    function render() {
      if (state.showPauseModal) {
        return renderPauseModal();
      }
      
      if (state.showStats) {
        return renderStatsView();
      }
      
      if (state.showWarning) {
        return renderWarningView();
      }
      
      if (state.countdownPhase) {
        return renderCountdownView();
      }
      
      if (state.diceNumber === null) {
        return renderStartScreen();
      }
      
      return renderGameView();
    }

    function renderWarningView() {
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="min-h-screen flex items-center justify-center bg-warning">
          <div class="text-center bg-black bg-opacity-50 p-12 rounded-lg">
            <div class="text-6xl font-bold text-white mb-4 animate-pulse">‚ö†Ô∏è WARNING ‚ö†Ô∏è</div>
            <div class="text-4xl font-bold text-white mb-2">THE ROBBERS ARE NOW ACTIVE</div>
            <div class="text-xl text-white mb-8">Rounds will be increased by 10 seconds</div>
            ${createButton({ 
              onclick: "skipWarning()", 
              title: "Continue: Continue with robber active", 
              text: "Continue Game",
              classes: "px-8 py-4 bg-white text-2xl font-bold text-green-700 rounded-lg hover:bg-gray-100"
            })}
          </div>
        </div>
      `;
    }

    function renderCountdownView() {
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="min-h-screen flex flex-col items-center justify-center bg-gray-900">
          <div class="text-9xl font-bold text-white">${state.countdownValue}</div>
        </div>
      `;
    }

    function renderStartScreen() {
      const app = document.getElementById('app');
      const hasSavedGame = state.roundLog.length > 0 || localStorage.getItem('catanTimerState');
      
      app.innerHTML = `
        <div class="min-h-screen flex flex-col items-center justify-center bg-gradient-to-br from-orange-600 via-orange-700 to-orange-800 text-white px-4">
          <div class="text-center mb-12">
            <h1 class="text-5xl md:text-7xl font-bold mb-6 text-shadow-lg">Catan Connect</h1>
            <p class="text-xl md:text-2xl text-orange-100 max-w-3xl leading-relaxed font-medium">
              Game management system for the mega game version of Catan
            </p>
            <p class="text-lg md:text-xl text-orange-200 max-w-2xl mt-3 leading-relaxed">
              Automatic timing ‚Ä¢ Dice rolling ‚Ä¢ Round tracking ‚Ä¢ Statistics
            </p>
          </div>

          <div class="flex flex-col gap-6 min-w-80 mb-8">
            ${hasSavedGame ? `
              ${createButton({ 
                onclick: "handleContinueGame()", 
                title: "Continue Game: Resume your saved game", 
                text: "CONTINUE GAME",
                classes: "px-8 py-4 bg-green-600 text-2xl font-bold text-white rounded-lg hover:bg-green-700 shadow-lg"
              })}
              <div class="text-center text-green-100 text-sm mb-2">
                Currently on Round ${state.round} 
              </div>
              <div class="border-t border-white opacity-30 my-2"></div>
            ` : ''}
            
            ${createButton({ 
              onclick: "confirmNewGame()", 
              title: "New Game: Start a completely fresh game", 
              text: "‚ú® START NEW GAME",
              classes: "px-8 py-4 bg-white text-2xl font-bold text-orange-700 rounded-lg hover:bg-gray-100 shadow-lg"
            })}
          </div>

          <!-- Round Time Settings -->
          <div class="flex flex-col items-center gap-4 mb-8">
            <div class="flex items-center gap-4 bg-black bg-opacity-30 px-6 py-3 rounded-lg">
              ${createButton({ 
                onclick: "adjustRoundTime(-5)", 
                title: "Decrease Timer: Decrease round time", 
                text: "‚àí",
                classes: "text-2xl font-bold hover:text-gray-300 px-3 py-1 bg-white bg-opacity-20 hover:bg-opacity-30 rounded"
              })}
              <div class="text-2xl font-bold text-white min-w-24 text-center">${state.roundTime}s per round</div>
              ${createButton({ 
                onclick: "adjustRoundTime(5)", 
                title: "Increase Timer: Increase round time", 
                text: "+",
                classes: "text-2xl font-bold hover:text-gray-300 px-3 py-1 bg-white bg-opacity-20 hover:bg-opacity-30 rounded"
              })}
            </div>
          </div>


          ${createButton({
            onclick: "showStatsPrompt()",
            title: "Settings: View stats, settings, and game info",
            text: "Settings & Statistics ‚öôÔ∏èüìä",
            classes: "text-lg md:text-xl px-6 py-2 font-bold text-orange-700 bg-black bg-opacity-100 rounded-lg hover:bg-opacity-60 flex items-center gap-2 transition-all"
          })}

          <!-- PWA Install Button (shown when installable) -->
          <button
            id="pwa-install-btn"
            onclick="installPWA()"
            style="display: none;"
            title="Install app to your device for offline use"
            class="text-lg md:text-xl px-6 py-3 font-bold text-white bg-blue-600 rounded-lg hover:bg-blue-700 shadow-lg transition-all flex items-center justify-center gap-2">
            üì± Install App (Works Offline)
          </button>
        </div>
      `;
    }

    function renderGameView() {
      const app = document.getElementById('app');
      // Main playing view
      let bgClass = state.round % 2 === 0 ? "bg-moon" : "bg-sun";
      if (state.isPaused) {
        bgClass = "bg-gray-600"; // Grey background when paused
      }
      const minutes = String(Math.floor(state.timeLeft / 60)).padStart(2,'0');
      const seconds = String(state.timeLeft % 60).padStart(2,'0');
      
      // Calculate current round length (includes robber bonus if applicable)
      const currentRoundLength = state.round >= GAME_CONFIG.ROBBER_START_ROUND ? 
        state.roundTime + GAME_CONFIG.ROBBER_TIME_BONUS : 
        state.roundTime;

      // Robber case - NO round number displayed
      if (state.diceNumber === 7 && state.round >= 11 && state.robberNumber !== null) {
        const robberDisplay = state.robberNumber === 'Desert' ? 'DESERT (7)' : state.robberNumber;
        const robberBgClass = state.isPaused ? "bg-gray-600" : "bg-warning";
        app.innerHTML = `
          <div class="flex flex-col min-h-screen ${robberBgClass} text-white" style="position: relative;">
            <div style="position: relative; z-index: 10;">
              ${renderGameControls(currentRoundLength)}
              <div class="flex-1 flex flex-col items-center justify-center px-4" style="min-height: 100vh;">
                <div class="shaded-rectangle w-full relative">
                  ${state.isPaused ? `
                    <div class="absolute left-1/4 top-1/2 transform -translate-x-1/2 -translate-y-1/2 text-6xl md:text-8xl font-bold text-gray-400 opacity-80 animate-pulse">PAUSED</div>
                    <div class="absolute right-1/4 top-1/2 transform translate-x-1/2 -translate-y-1/2 text-6xl md:text-8xl font-bold text-gray-400 opacity-80 animate-pulse">PAUSED</div>
                  ` : ''}
                  <div class="robber-label font-bold text-center" style="font-size: clamp(5.2rem, 13vw, 9.1rem); line-height:1.1;">
                    ROBBER ON<br>${robberDisplay}
                  </div>
                </div>
                <div class="text-center" style="font-size: clamp(1.5rem, 4vw, 2.5rem); line-height:1.4; max-width: 90vw;">
                  If you have more than 7 resources,<br>discard half (rounded down)
                </div>
                <div class="timer-text font-mono font-bold mt-4 md:mt-8" style="font-size: clamp(3rem, 10vw, 7rem);">${minutes}:${seconds}</div>
                ${renderGameButtons()}
              </div>
            </div>
            ${renderPausedOverlay()}
          </div>
        `;
      } else {
        // Normal display with round number
        const activeLabel = (state.round % 2 === 0) ? "Moon Active" : "Sun Active";
        const activeLabelClass = (state.round % 2 === 0) ? "moon-active" : "sun-active";
        
        app.innerHTML = `
          <div class="flex flex-col min-h-screen ${bgClass} text-white" style="position: relative;">
            <div style="position: relative; z-index: 10;">
              ${renderGameControls(currentRoundLength)}
              <div class="flex-1 flex flex-col items-center justify-center px-4" style="min-height: 100vh;">
                <div class="shaded-rectangle w-full relative">
                  ${state.isPaused ? `
                    <div class="absolute left-1/4 top-1/2 transform -translate-x-1/2 -translate-y-1/2 text-6xl md:text-8xl font-bold text-white opacity-80 animate-pulse">PAUSED</div>
                    <div class="absolute right-1/4 top-1/2 transform translate-x-1/2 -translate-y-1/2 text-6xl md:text-8xl font-bold text-white opacity-80 animate-pulse">PAUSED</div>
                  ` : ''}
                  <div class="dice-number font-bold text-center" style="font-size: clamp(7rem, 15vw, 18rem); line-height:1;">${state.diceNumber}</div>
                  <div class="active-label font-bold text-center ${activeLabelClass}" style="font-size: clamp(2.73rem, 7.28vw, 4.55rem); line-height:1.4; margin-top: 1rem; ${state.isPaused ? (state.round % 2 === 0 ? 'color: #001f3f !important;' : 'color: #cc5500 !important;') : ''}">${activeLabel}</div>
                </div>
                <div class="timer-text font-mono font-bold mt-4 md:mt-8" style="font-size: clamp(3rem, 10vw, 7rem);">${minutes}:${seconds}</div>
                ${renderGameButtons()}
              </div>
            </div>
          </div>
        `;
      }
    }

    function renderGameControls(currentRoundLength) {
      return `
        <div class="absolute top-4 md:top-8 left-4 md:left-8 flex items-center gap-2 md:gap-4 bg-black bg-opacity-40 px-3 md:px-6 py-2 md:py-3 rounded-lg text-sm md:text-base">
          <div class="text-lg md:text-xl font-bold text-yellow-300">Round ${state.round}</div>
          <div class="h-6 w-px bg-white opacity-30 mx-1 md:mx-2"></div>
          ${createButton({ 
            onclick: "adjustRoundTime(-5)", 
            title: "Decrease Timer: Decrease round time", 
            text: "‚àí",
            classes: "text-xl md:text-3xl font-bold hover:text-gray-300 px-2 md:px-3"
          })}
          <div class="text-lg md:text-2xl font-bold">${currentRoundLength}s</div>
          ${createButton({ 
            onclick: "adjustRoundTime(5)", 
            title: "Increase Timer: Increase round time", 
            text: "+",
            classes: "text-xl md:text-3xl font-bold hover:text-gray-300 px-2 md:px-3"
          })}
          <div class="h-6 w-px bg-white opacity-30 mx-1 md:mx-2"></div>
          ${createButton({ 
            onclick: "showStatsPrompt()", 
            title: "Menu: For stats, info, settings, or to start a new game", 
            text: "‚öôÔ∏è/üìä",
            classes: "text-lg md:text-2xl font-bold hover:text-gray-300"
          })}
          ${createButton({ 
            onclick: "toggleFullscreen()",
            title: "Fullscreen: Toggle fullscreen",
            text: "‚õ∂",
            classes: "text-lg md:text-2xl font-bold hover:text-gray-300"
          })}
        </div>
      `;
    }

    function renderGameButtons() {
      return `
        <div class="flex gap-4 md:gap-6 mt-4 md:mt-6">
          ${createButton({ 
            onclick: "togglePause()", 
            title: `${state.isPaused ? 'Resume: Resume timer' : 'Pause: Pause timer'}`, 
            text: state.isPaused ? '‚ñ∂' : '‚è∏',
            classes: "p-4 md:p-6 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-full transition-all text-2xl md:text-4xl"
          })}
          ${createButton({ 
            onclick: "handleNext()", 
            title: "Next Round: Skip to next round", 
            text: "‚è≠",
            classes: "p-4 md:p-6 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-full transition-all text-2xl md:text-4xl"
          })}
        </div>
      `;
    }

    function renderPausedOverlay() {
      // PAUSED status now shown in top control bar instead of overlay
      return '';
    }

    // Placeholder content render functions - these need to be extracted from the old render function
    function renderStatsContent() {
      const statsHTML = state.roundLog.map(log => `
        <tr class="border-b border-gray-700">
          <td class="px-4 py-3 font-bold text-yellow-300">${log.round}</td>
          <td class="px-4 py-3 text-center">
            <span class="text-2xl font-bold ${log.dice === 7 ? 'text-red-400' : 'text-white'}">${log.dice}</span>
          </td>
          <td class="px-4 py-3 text-center ${log.robber ? 'text-red-400 font-bold' : 'text-gray-500'}">
            ${log.robber || '‚Äî'}
          </td>
          <td class="px-4 py-3 text-gray-400 text-sm">${log.duration}s</td>
        </tr>
      `).join('');

      const totalRounds = state.roundLog.length;
      const robberRounds = state.roundLog.filter(log => log.robber !== null).length;
      const diceCounts = {};
      state.roundLog.forEach(log => {
        diceCounts[log.dice] = (diceCounts[log.dice] || 0) + 1;
      });
      const mostCommon = Object.entries(diceCounts).sort((a, b) => b[1] - a[1])[0];

      return `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div class="bg-gradient-to-br from-blue-600 to-blue-800 p-4 rounded-lg">
            <div class="text-sm opacity-80">Total Rounds</div>
            <div class="text-3xl font-bold">${totalRounds}</div>
          </div>
          <div class="bg-gradient-to-br from-red-600 to-red-800 p-4 rounded-lg">
            <div class="text-sm opacity-80">Robber Activations</div>
            <div class="text-3xl font-bold">${robberRounds}</div>
          </div>
          <div class="bg-gradient-to-br from-green-600 to-green-800 p-4 rounded-lg">
            <div class="text-sm opacity-80">Most Common Roll</div>
            <div class="text-3xl font-bold">${mostCommon ? `${mostCommon[0]} (√ó${mostCommon[1]})` : 'N/A'}</div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-4">
          ${createButton({ 
            onclick: "copyStats()", 
            title: "Copy statistics to clipboard", 
            text: "üìã Copy Stats",
            classes: "px-4 py-3 bg-green-600 rounded hover:bg-green-700 font-bold text-sm md:text-base"
          })}
          
          ${createButton({ 
            onclick: "exportStatsCSV()", 
            title: "Download statistics as CSV file", 
            text: "üì• Export CSV",
            classes: "px-4 py-3 bg-purple-600 rounded hover:bg-purple-700 font-bold text-sm md:text-base"
          })}
        </div>

        <div class="bg-gray-800 rounded-lg overflow-hidden">
          <div class="overflow-x-auto max-h-96">
            <table class="w-full">
              <thead class="bg-gray-700 sticky top-0">
                <tr>
                  <th class="px-4 py-3 text-left text-sm font-bold">Round</th>
                  <th class="px-4 py-3 text-center text-sm font-bold">Dice</th>
                  <th class="px-4 py-3 text-center text-sm font-bold">Robber</th>
                  <th class="px-4 py-3 text-left text-sm font-bold">Duration</th>
                </tr>
              </thead>
              <tbody>
                ${statsHTML.length > 0 ? statsHTML : '<tr><td colspan="4" class="text-center text-gray-400 py-8">No rounds played yet</td></tr>'}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    function renderAdvancedStatsContent() {
      // Calculate advanced stats
      const diceCounts = {2:0, 3:0, 4:0, 5:0, 6:0, 8:0, 9:0, 10:0, 11:0, 12:0};
      const robberDiceCounts = {1:0, 2:0, 3:0, 4:0, 5:0, 6:0, 8:0, 9:0, 10:0, 11:0, 12:0};
      let sevenCount = 0;
      
      state.roundLog.forEach(log => {
        if (log.dice === 7) {
          sevenCount++;
          if (log.robber) {
            robberDiceCounts[log.robber] = (robberDiceCounts[log.robber] || 0) + 1;
          }
        } else {
          diceCounts[log.dice] = (diceCounts[log.dice] || 0) + 1;
        }
      });
      
      // Expected probabilities for 2d6 (excluding 7)
      const expectedProb = {
        2: 2.78, 3: 5.56, 4: 8.33, 5: 11.11, 6: 13.89,
        8: 13.89, 9: 11.11, 10: 8.33, 11: 5.56, 12: 2.78
      };
      
      const totalRolls = state.roundLog.filter(log => log.dice !== 7).length;
      
      // Calculate longest streak without robber
      let currentStreak = 0;
      let longestStreak = 0;
      state.roundLog.forEach(log => {
        if (log.robber === null) {
          currentStreak++;
          longestStreak = Math.max(longestStreak, currentStreak);
        } else {
          currentStreak = 0;
        }
      });
      
      // Average round duration
      const totalDuration = state.roundLog.reduce((sum, log) => sum + (log.duration || 0), 0);
      const avgDuration = state.roundLog.length > 0 ? Math.round(totalDuration / state.roundLog.length) : 0;
      
      const probabilityChart = Object.keys(diceCounts).map(num => {
        const actual = totalRolls > 0 ? ((diceCounts[num] / totalRolls) * 100).toFixed(1) : 0;
        const expected = expectedProb[num];
        const diff = totalRolls > 0 ? (actual - expected).toFixed(1) : 0;
        
        return `
          <div class="mb-4">
            <div class="flex justify-between mb-1">
              <span class="font-bold">${num}</span>
              <span class="text-sm">
                <span class="text-blue-400">Actual: ${actual}%</span> | 
                <span class="text-gray-400">Expected: ${expected}%</span> |
                <span class="${diff >= 0 ? 'text-green-400' : 'text-red-400'}">${diff > 0 ? '+' : ''}${diff}%</span>
              </span>
            </div>
            <div class="relative h-8 bg-gray-700 rounded overflow-hidden">
              <div class="absolute h-full bg-orange-300 opacity-60" style="width: ${expected}%"></div>
              <div class="absolute h-full bg-blue-500" style="width: ${actual}%"></div>
              <div class="absolute inset-0 flex items-center justify-center text-xs font-bold">
                ${diceCounts[num]} rolls
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      const robberDiceChart = Object.keys(robberDiceCounts)
        .sort((a, b) => {
          // Special case: DESERT (7) should be treated as 7 for sorting
          const aNum = a.includes('DESERT') ? 7 : Number(a);
          const bNum = b.includes('DESERT') ? 7 : Number(b);
          return aNum - bNum;
        })
        .map(num => {
          const count = robberDiceCounts[num];
          const displayNum = num;
          return `
            <div class="mb-3">
              <div class="flex justify-between mb-1">
                <span class="font-bold">${displayNum}</span>
                <span class="text-sm text-red-400">${count} times</span>
              </div>
              <div class="relative h-6 bg-gray-700 rounded overflow-hidden">
                <div class="absolute h-full bg-red-500" style="width: ${sevenCount > 0 ? (count / sevenCount * 100) : 0}%"></div>
              </div>
            </div>
          `;
        }).join('');
      
      return `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          <div class="bg-gradient-to-br from-purple-600 to-purple-800 p-4 rounded-lg">
            <div class="text-sm opacity-80">Longest Streak (No Robber)</div>
            <div class="text-3xl font-bold">${longestStreak} rounds</div>
          </div>
          <div class="bg-gradient-to-br from-orange-600 to-orange-800 p-4 rounded-lg">
            <div class="text-sm opacity-80">Average Round Duration</div>
            <div class="text-3xl font-bold">${avgDuration}s</div>
          </div>
        </div>
        
        <div class="bg-gray-800 p-6 rounded-lg mb-6">
          <h3 class="text-xl font-bold mb-4">Dice Roll Probability Analysis</h3>
          <p class="text-sm text-gray-400 mb-4">Blue bars show actual rolls, gray bars show expected probability for fair 2d6 dice.</p>
          ${probabilityChart}
          <div class="mt-6 p-4 bg-red-900 bg-opacity-30 rounded border border-red-700">
            <div class="flex justify-between items-center">
              <span class="font-bold text-red-300">Robber (7s only accepted from round ${state.robberStartRound})</span>
              <span class="text-2xl font-bold text-red-400">${sevenCount} times</span>
            </div>
          </div>
        </div>
        
        <div class="bg-gray-800 p-6 rounded-lg">
          <h3 class="text-xl font-bold mb-4">Robber Dice Distribution</h3>
          <p class="text-sm text-gray-400 mb-4">When a 7 is rolled the robbers are activated and two more D6s are rolled to determine where the robbers get placed. This shows the distribution of the robber placement dice.</p>
          ${sevenCount > 0 ? robberDiceChart : '<p class="text-gray-500 text-center py-4">No robber activations yet</p>'}
        </div>
      `;
    }

    function renderSettingsContent() {
      const timings = [
        { key: '10sec', label: '10 seconds remaining' },
        { key: '5sec', label: '5 seconds remaining' },
        { key: '3sec', label: '3 seconds remaining' },
        { key: '1sec', label: '1 second remaining' }
      ];

      return `
        <div class="space-y-6">
          <!-- Sound Settings -->
          <div class="${UI_CONSTANTS.CSS_CLASSES.CARD_HEADER}">
            <h2 class="text-xl font-bold mb-4 text-center bg-green-600 py-2 rounded">üîä Sound Settings</h2>
            
            <div class="${UI_CONSTANTS.CSS_CLASSES.CARD} space-y-6">
              <div class="flex justify-between items-center mb-4">
                <div>
                  <h3 class="text-lg font-bold">Chimes</h3>
                  <p class="text-sm text-gray-400">Play sound at specific times</p>
                </div>
                ${createButton({ 
                  onclick: "toggleSetting('chimeEnabled')", 
                  title: "Toggle chime sounds", 
                  text: state.chimeEnabled ? 'ON' : 'OFF',
                  classes: `px-6 py-3 rounded font-bold ${state.chimeEnabled ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-600 hover:bg-gray-700'}`
                })}
              </div>
              
              <div>
                <h4 class="text-md font-bold mb-2">Chime Timing</h4>
                <div class="space-y-2">
                  ${createTimingCheckboxes('chime', timings)}
                </div>
              </div>
              
              <div>
                <h4 class="text-md font-bold mb-2">Volume (${state.chimeVolume}%)</h4>
                <div class="flex items-center gap-4 mb-2">
                  <span class="text-sm">üîá</span>
                  <input type="range" min="0" max="100" step="10" value="${state.chimeVolume}" 
                    oninput="updateSetting('chimeVolume', this.value)"
                    class="flex-1 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                  <span class="text-sm">üîä</span>
                </div>
                <div class="text-center">
                  ${createButton({ 
                    onclick: "playChime()", 
                    title: "Test chime sound", 
                    text: "üîä Test Chime",
                    classes: "px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-sm font-bold"
                  })}
                </div>
              </div>
            </div>
          </div>
          
          <!-- Vibration Settings -->
          <div class="${UI_CONSTANTS.CSS_CLASSES.CARD_HEADER}">
            <h2 class="text-xl font-bold mb-4 text-center bg-purple-600 py-2 rounded">üì≥ Vibration Settings</h2>
            
            <div class="${UI_CONSTANTS.CSS_CLASSES.CARD}">
              <div class="flex justify-between items-center mb-4">
                <div>
                  <h3 class="text-lg font-bold">Vibration</h3>
                  <p class="text-sm text-gray-400">Vibrate device during countdown</p>
                </div>
                ${createButton({ 
                  onclick: "toggleSetting('vibrationEnabled')", 
                  title: "Toggle vibration", 
                  text: state.vibrationEnabled ? 'ON' : 'OFF',
                  classes: `px-6 py-3 rounded font-bold ${state.vibrationEnabled ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-600 hover:bg-gray-700'}`
                })}
              </div>
              
              <div>
                <h4 class="text-md font-bold mb-2">Vibration Timing</h4>
                <div class="space-y-2">
                  ${createTimingCheckboxes('vibrate', timings)}
                </div>
                <div class="text-center mt-4">
                  ${createButton({ 
                    onclick: "testVibration()", 
                    title: "Test vibration", 
                    text: "üì≥ Test Vibration",
                    classes: "px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded text-sm font-bold"
                  })}
                </div>
              </div>
            </div>
          </div>
          
          <!-- Flash Settings -->
          <div class="${UI_CONSTANTS.CSS_CLASSES.CARD_HEADER}">
            <h2 class="text-xl font-bold mb-4 text-center bg-red-600 py-2 rounded">‚ö° Flash Settings</h2>
            
            <div class="${UI_CONSTANTS.CSS_CLASSES.CARD} space-y-6">
              <!-- Flash Types -->
              <div>
                <h3 class="text-lg font-bold mb-2">Flash Types</h3>
                <p class="text-sm text-gray-400 mb-3">Choose which flash types to enable (can select both)</p>
                <div class="space-y-3">
                  <div class="flex items-center gap-3">
                    ${createCheckbox('flashTextEnabled', 'Flash text', UI_CONSTANTS.CSS_CLASSES.CHECKBOX_LARGE)}
                  </div>
                  <div class="flex items-center gap-3">
                    ${createCheckbox('flashFullscreenEnabled', 'Flash background', UI_CONSTANTS.CSS_CLASSES.CHECKBOX_LARGE)}
                  </div>
                </div>
              </div>
              
              <!-- Flash Colour -->
              <div>
                <h3 class="text-lg font-bold mb-2">Fullscreen Flash Colour & Opacity</h3>
                <p class="text-sm text-gray-400 mb-3">Customise fullscreen flash colour and intensity (text flash is always red)</p>
                <div class="space-y-3">
                  <div class="flex items-center gap-4">
                    <input type="color" value="${state.flashColor}" 
                      onchange="updateSetting('flashColor', this.value)"
                      class="w-12 h-12 rounded border-2 border-gray-600 cursor-pointer">
                    <span class="text-white font-mono">${state.flashColor}</span>
                    ${createButton({ onclick: `updateSetting('flashColor', '${UI_CONSTANTS.COLORS.FLASH_RED}')`, title: "Set to red", text: "Red", classes: "px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-sm" })}
                    ${createButton({ onclick: "updateSetting('flashColor', '#ffff00')", title: "Set to yellow", text: "Yellow", classes: "px-3 py-1 bg-yellow-500 hover:bg-yellow-600 rounded text-sm" })}
                    ${createButton({ onclick: "updateSetting('flashColor', '#ff8800')", title: "Set to orange", text: "Orange", classes: "px-3 py-1 bg-orange-500 hover:bg-orange-600 rounded text-sm" })}
                  </div>
                  <div>
                    <label class="text-sm font-medium text-gray-300 mb-2 block">Opacity: ${state.flashOpacity}%</label>
                    <div class="flex items-center gap-4">
                      <span class="text-sm">Light</span>
                      <input type="range" min="10" max="80" step="5" value="${state.flashOpacity}" 
                        oninput="updateSetting('flashOpacity', this.value)"
                        class="flex-1 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                      <span class="text-sm">Strong</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Flash Timing -->
              <div>
                <h3 class="text-lg font-bold mb-2">Flash Timing</h3>
                <p class="text-sm text-gray-400 mb-3">Start flashing when time reaches (${state.flashThreshold} seconds)</p>
                <div class="flex items-center gap-4">
                  ${createButton({ 
                    onclick: `updateSetting('flashThreshold', ${Math.max(1, state.flashThreshold - 1)})`, 
                    title: "Decrease flash threshold", 
                    text: "‚àí",
                    classes: "px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded font-bold"
                  })}
                  <div class="flex-1 text-center">
                    <div class="text-2xl font-bold">${state.flashThreshold}s</div>
                  </div>
                  ${createButton({ 
                    onclick: `updateSetting('flashThreshold', ${Math.min(15, state.flashThreshold + 1)})`, 
                    title: "Increase flash threshold", 
                    text: "+",
                    classes: "px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded font-bold"
                  })}
                </div>
              </div>
              
              <!-- Flash Speed -->
              <div>
                <h3 class="text-lg font-bold mb-2">Flash Speed</h3>
                <p class="text-sm text-gray-400 mb-3">How fast the warning flash alternates</p>
                <div class="flex items-center gap-4">
                  <span class="text-sm">Slow</span>
                  <input type="range" min="${GAME_CONFIG.FLASH_SPEEDS.MIN}" max="${GAME_CONFIG.FLASH_SPEEDS.MAX}" step="${GAME_CONFIG.FLASH_SPEEDS.STEP}" value="${GAME_CONFIG.FLASH_SPEEDS.MAX + GAME_CONFIG.FLASH_SPEEDS.MIN - state.flashSpeed}" 
                    oninput="updateSetting('flashSpeed', ${GAME_CONFIG.FLASH_SPEEDS.MAX} + ${GAME_CONFIG.FLASH_SPEEDS.MIN} - this.value)"
                    class="flex-1 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                  <span class="text-sm">Fast</span>
                </div>
                <div class="mt-2 text-center text-sm text-gray-400">
                  Speed: ${state.flashSpeed < 500 ? 'Very Fast' : state.flashSpeed < 700 ? 'Fast' : state.flashSpeed < 900 ? 'Normal' : 'Slow'} (${state.flashSpeed}ms)
                </div>
              </div>
            </div>
          </div>
          
          <!-- Robber Settings -->
          <div class="${UI_CONSTANTS.CSS_CLASSES.CARD_HEADER}">
            <h2 class="text-xl font-bold mb-4 text-center bg-green-600 py-2 rounded">üéØ Robber Settings</h2>
            
            <div class="${UI_CONSTANTS.CSS_CLASSES.CARD}">
              <h3 class="text-lg font-bold mb-2">Robber Activation Round</h3>
              <p class="text-sm text-gray-400 mb-4">Which round the robber becomes active (currently: ${state.robberStartRound})</p>
              <div class="flex items-center gap-4">
                ${createButton({ 
                  onclick: `updateSetting('robberStartRound', ${Math.max(1, state.robberStartRound - 1)})`, 
                  title: "Decrease robber activation round", 
                  text: "‚àí",
                  classes: "px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded font-bold text-xl"
                })}
                <div class="flex-1 text-center">
                  <div class="text-4xl font-bold">${state.robberStartRound}</div>
                </div>
                ${createButton({ 
                  onclick: `updateSetting('robberStartRound', ${Math.min(99, state.robberStartRound + 1)})`, 
                  title: "Increase robber activation round", 
                  text: "+",
                  classes: "px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded font-bold text-xl"
                })}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderInfoContent() {
      return `
        <div class="space-y-6">
          <!-- Keyboard Shortcuts -->
          <div class="bg-gray-800 p-6 rounded-lg">
            <h3 class="text-xl font-bold mb-4">‚å®Ô∏è Keyboard Shortcuts</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <div class="flex justify-between items-center bg-gray-700 px-4 py-2 rounded">
                <span class="text-sm">Pause/Resume</span>
                <kbd class="px-3 py-1 bg-gray-900 rounded font-mono text-xs">SPACE</kbd>
              </div>
              <div class="flex justify-between items-center bg-gray-700 px-4 py-2 rounded">
                <span class="text-sm">Next Round</span>
                <kbd class="px-3 py-1 bg-gray-900 rounded font-mono text-xs">N</kbd>
              </div>
              <div class="flex justify-between items-center bg-gray-700 px-4 py-2 rounded">
                <span class="text-sm">Open Stats</span>
                <kbd class="px-3 py-1 bg-gray-900 rounded font-mono text-xs">S</kbd>
              </div>
            </div>
          </div>
          
          <!-- About -->
          <div class="bg-gray-800 p-6 rounded-lg">
            <h3 class="text-xl font-bold mb-4">‚ÑπÔ∏è About Catan Connect</h3>
            <p class="text-sm text-gray-300 mb-4">
              A digital timer and dice roller for the mega game version of Catan known as <strong>Catan Connect</strong>. 
              With multiple copies, this game can be played with an exponential number of people, although always at even numbers. 
              Features automatic round progression, robber mechanics, statistics tracking, and customisable settings.
            </p>
            <p class="text-sm text-gray-300 mb-4">
              <a href="https://boardgamegeek.com/boardgame/451387/catan-connect" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:text-blue-300 underline">
                View Catan Connect on BoardGameGeek ‚Üí
              </a>
            </p>
            <p class="text-xs text-gray-500">
              Version 1.0 | Built with HTML, CSS & JavaScript
            </p>
          </div>
          
          <!-- Image -->
          <div class="bg-gray-800 p-6 rounded-lg text-center">
            <img src="Catan_Connect_Front_v1.png" alt="Catan Connect Front" class="w-full max-w-md mx-auto rounded-lg shadow-lg mb-4" onerror="this.style.display='none'">
            <img src="Catan_Connect_Back_v1.png" alt="Catan Connect Back" class="w-full max-w-md mx-auto rounded-lg shadow-lg" onerror="this.style.display='none'">
          </div>
          
          <!-- Teaching Script -->
          <div class="bg-gray-800 p-6 rounded-lg">
            <h3 class="text-xl font-bold mb-4">üìñ Teaching Script</h3>
            <div class="text-sm text-gray-300 space-y-3 max-h-96 overflow-y-auto">
              <p class="font-bold text-lg">Welcome to Catan Connect</p>
              
              <p>In this fast-paced mega game of Catan you will be racing to 18 points.</p>
              
              <p>Each round I will announce whether the moon-side or the sun side is active, and from round 11 onwards whether the robber is robbing.</p>
              
              <p>Each round will go for 30 seconds, although I can lengthen this if needed.</p>
              
              <p>Every player starts with 1 of each of the resources matching the hexes surrounding their city, and 4 points ‚Äî 2 for their city and 2 for their two settlements.</p>
              
              <p>Each player starts on a region of their own, with a robber which can only be moved within your own region.</p>
              
              <p>Each time you build your first settlement into the region on your left or right you will gain 2 victory points, and you can mark that on your playmat.</p>
              
              <p class="font-bold">There are development tiles which can be purchased from either side of the game mat you are on. These include:</p>
              
              <ul class="list-disc list-inside space-y-2 ml-4">
                <li><strong>Road Building (x1)</strong><br>When you play this tile, build 2 roads at no cost</li>
                
                <li><strong>Invention/Year of Plenty (x1)</strong><br>When you play this tile, take any 2 resources from the supply</li>
                
                <li><strong>Victory Point (x2)</strong><br>When you are the active player, you may reveal all your Victory Point tiles, including any purchased on that turn, if you can reach the number of VPs needed to win. Otherwise, keep Victory Point tiles face down in front of you</li>
                
                <li><strong>Knight (x5)</strong><br>When you play the Knight tile:<br>
                Move the robber to the desert and take 1 resource corresponding to the hex where the robber was, OR;<br>
                If the robber is already in the desert, it remains there and you may take 1 resource of your choice from the supply</li>
              </ul>
              
              <p>If you and your direct opponent ever buy all the development tiles from your game mat, you may purchase them from a neighbour's supply.</p>
              
              <p>There should be banks of resources within everyone's reach. When a number is rolled that matches the number on a hex you built on, take the resource/s that matches (1 for a settlement and 2 for a city).</p>
              
              <p>If there are ever no resources available please throw your hand up so we can replenish the banks.</p>
              
              <p class="font-bold">A general turn goes like this:</p>
              
              <ol class="list-decimal list-inside space-y-2 ml-4">
                <li>I will announce which side is active and what the dice roll is</li>
                <li>All players will collect the resources as per the roll</li>
                <li>All players can trade with the five people surrounding them</li>
                <li>All players can trade at trading posts if they have built a settlement or a city there</li>
                <li>If you are the active player and are at one of the ends you may also trade with the Market. At the market you may, once per turn, trade one resource for another resource at the market.</li>
                <li>Active players can buy or build any roads, settlements, cities or development tiles</li>
                <li>Active players can play 1 development tile which they have bought on a previous turn</li>
                <li>The active player may reveal all their Victory Point tiles, including any purchased this turn, if they can reach the number of VPs needed to win</li>
              </ol>
              
              <p class="font-bold">Sevens can only be rolled after the 11th round.</p>
              
              <p>When a robber is rolled you will need to move it to the number on your mat which corresponds with the number I give.</p>
              
              <p>The robber doesn't rob in this version of Catan. Instead its purpose is to block.</p>
              
              <p>You will have to halve your resource pool however if you have over 7 resources. This is rounded down, so if you have 9 resources you only have to get rid of 4.</p>
              
              <p class="font-bold">The competition of Longest Road and Largest Army is only between you and the person sharing your mat.</p>
              
              <p>For Longest Road you will need at least 5 of your roads connected, or, after that, more than the other player.</p>
              
              <p>For Largest Army you need to have played out at least 2 Knights, or, after that, more than the other player.</p>
              
              <p>If you gain either of these, mark the spot on your mat to claim it and move your point marker up 2 spaces.</p>
              
              <p>If your opponent takes this achievement from you, they will take your marker to mark on their side on the mat and you will need to put your point tracker down by 2 spaces.</p>
              
              <p>Because this is a fast paced game, mistakes will be made, and that is okay. Everyone will make a mistake at some point and the point is to have fun. If you ever need a moment to understand something though, please throw your hand up so I can pause the game.</p>
              
              <p class="font-bold text-lg">Does anyone have any questions?</p>
            </div>
          </div>
        </div>
      `;
    }

    function OLD_RENDER_TO_REPLACE() {
      const app = document.getElementById('app');

      // Keep this function temporarily to avoid breaking while I replace content
      // Remove after extracting all content render functions
      
      // Pause modal - different message if already paused
      if (state.showPauseModal) {
        if (state.isPaused) {
          app.innerHTML = `
            <div class="modal-overlay">
              <div class="bg-gray-800 p-8 rounded-lg text-white text-center max-w-md">
                <h2 class="text-2xl font-bold mb-4">Timer is Paused</h2>
                <p class="mb-6">The timer is currently paused. Continue to view settings & statistics.</p>
                <div class="flex gap-4 justify-center">
                  <button onclick="handleStatsChoice(false)" class="px-6 py-3 bg-green-600 rounded hover:bg-green-700 font-bold">
                    Continue
                  </button>
                </div>
              </div>
            </div>
          `;
        } else {
          app.innerHTML = `
            <div class="modal-overlay">
              <div class="bg-gray-800 p-8 rounded-lg text-white text-center max-w-md">
                <h2 class="text-2xl font-bold mb-4">View Settings & Statistics</h2>
                <p class="mb-6">Would you like to pause the game?</p>
                <div class="flex gap-4 justify-center">
                  <button onclick="handleStatsChoice(true)" class="px-6 py-3 bg-blue-600 rounded hover:bg-blue-700 font-bold">
                    Yes, Pause
                  </button>
                  <button onclick="handleStatsChoice(false)" class="px-6 py-3 bg-green-600 rounded hover:bg-green-700 font-bold">
                    No, Continue
                  </button>
                </div>
              </div>
            </div>
          `;
        }
        return;
      }

      // Stats view
      if (state.showStats) {
        // Navigation tabs with hover tooltips
        const tabs = `
          <div class="flex gap-2 mb-6 overflow-x-auto flex-wrap">
            <!-- Stats Tab Button -->
            <button onclick="changeView('stats')" title="Stats: View game statistics and round history" class="px-4 py-2 rounded font-bold ${state.currentView === 'stats' ? 'bg-blue-600' : 'bg-gray-700 hover:bg-gray-600'}">
              üìä Stats
            </button>
            <!-- Advanced Tab Button -->
            <button onclick="changeView('advanced')" title="Advanced: View dice probability analysis and advanced metrics" class="px-4 py-2 rounded font-bold ${state.currentView === 'advanced' ? 'bg-blue-600' : 'bg-gray-700 hover:bg-gray-600'}">
              üìà Advanced
            </button>
            <!-- Settings Tab Button -->
            <button onclick="changeView('settings')" title="Settings: Configure game settings and preferences" class="px-4 py-2 rounded font-bold ${state.currentView === 'settings' ? 'bg-blue-600' : 'bg-gray-700 hover:bg-gray-600'}">
              ‚öôÔ∏è Settings
            </button>
            <!-- Info Tab Button -->
            <button onclick="changeView('info')" title="Info: View keyboard shortcuts, rules, and about information" class="px-4 py-2 rounded font-bold ${state.currentView === 'info' ? 'bg-blue-600' : 'bg-gray-700 hover:bg-gray-600'}">
              ‚ÑπÔ∏è Info
            </button>
            <!-- Start Screen Button -->
            <button onclick="showNewGameConfirm()" title="Start Screen: Go to start screen to begin a new game" class="px-4 py-2 rounded font-bold bg-orange-600 hover:bg-orange-700">
              üè† Start Screen
            </button>
          
          </div>
        `;
        
        let content = '';
        
        // STATS VIEW
        if (state.currentView === 'stats') {
          const statsHTML = state.roundLog.map(log => `
            <tr class="border-b border-gray-700">
              <td class="px-4 py-3 font-bold text-yellow-300">${log.round}</td>
              <td class="px-4 py-3 text-center">
                <span class="text-2xl font-bold ${log.dice === 7 ? 'text-red-400' : 'text-white'}">${log.dice}</span>
              </td>
              <td class="px-4 py-3 text-center ${log.robber ? 'text-red-400 font-bold' : 'text-gray-500'}">
                ${log.robber || '‚Äî'}
              </td>
              <td class="px-4 py-3 text-gray-400 text-sm">${log.duration}s</td>
            </tr>
          `).join('');

          const totalRounds = state.roundLog.length;
          const robberRounds = state.roundLog.filter(log => log.robber !== null).length;
          const diceCounts = {};
          state.roundLog.forEach(log => {
            diceCounts[log.dice] = (diceCounts[log.dice] || 0) + 1;
          });
          const mostCommon = Object.entries(diceCounts).sort((a, b) => b[1] - a[1])[0];

          content = `
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
              <div class="bg-gradient-to-br from-blue-600 to-blue-800 p-4 rounded-lg">
                <div class="text-sm opacity-80">Total Rounds</div>
                <div class="text-3xl font-bold">${totalRounds}</div>
              </div>
              <div class="bg-gradient-to-br from-red-600 to-red-800 p-4 rounded-lg">
                <div class="text-sm opacity-80">Robber Activations</div>
                <div class="text-3xl font-bold">${robberRounds}</div>
              </div>
              <div class="bg-gradient-to-br from-green-600 to-green-800 p-4 rounded-lg">
                <div class="text-sm opacity-80">Most Common Roll</div>
                <div class="text-3xl font-bold">${mostCommon ? `${mostCommon[0]} (√ó${mostCommon[1]})` : 'N/A'}</div>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-4">
              <button onclick="copyStats()" title="Copy statistics to clipboard" class="px-4 py-3 bg-green-600 rounded hover:bg-green-700 font-bold text-sm md:text-base">
                üìã Copy Stats
              </button>
              
              <button onclick="exportStatsCSV()" title="Download statistics as CSV file" class="px-4 py-3 bg-purple-600 rounded hover:bg-purple-700 font-bold text-sm md:text-base">
                üì• Export CSV
              </button>
            </div>

            <div class="bg-gray-800 rounded-lg overflow-hidden">
              <div class="overflow-x-auto max-h-96">
                <table class="w-full">
                  <thead class="bg-gray-700 sticky top-0">
                    <tr>
                      <th class="px-4 py-3 text-left text-sm font-bold">Round</th>
                      <th class="px-4 py-3 text-center text-sm font-bold">Dice</th>
                      <th class="px-4 py-3 text-center text-sm font-bold">Robber</th>
                      <th class="px-4 py-3 text-left text-sm font-bold">Duration</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${statsHTML.length > 0 ? statsHTML : '<tr><td colspan="4" class="text-center text-gray-400 py-8">No rounds played yet</td></tr>'}
                  </tbody>
                </table>
              </div>
            </div>
          `;
        }
        
        // ADVANCED STATS VIEW
        else if (state.currentView === 'advanced') {
          // Calculate advanced stats
          const diceCounts = {2:0, 3:0, 4:0, 5:0, 6:0, 8:0, 9:0, 10:0, 11:0, 12:0};
          const robberDiceCounts = {1:0, 2:0, 3:0, 4:0, 5:0, 6:0, 8:0, 9:0, 10:0, 11:0, 12:0};
          let sevenCount = 0;
          
          state.roundLog.forEach(log => {
            if (log.dice === 7) {
              sevenCount++;
              if (log.robber) {
                if (log.robber === 'Desert') {
                  robberDiceCounts[7] = (robberDiceCounts[7] || 0) + 1;
                } else {
                  robberDiceCounts[log.robber] = (robberDiceCounts[log.robber] || 0) + 1;
                }
              }
            } else {
              diceCounts[log.dice] = (diceCounts[log.dice] || 0) + 1;
            }
          });
          
          // Expected probabilities for 2d6 (excluding 7)
          const expectedProb = {
            2: 2.78, 3: 5.56, 4: 8.33, 5: 11.11, 6: 13.89,
            8: 13.89, 9: 11.11, 10: 8.33, 11: 5.56, 12: 2.78
          };
          
          const totalRolls = state.roundLog.filter(log => log.dice !== 7).length;
          
          // Calculate longest streak without robber
          let currentStreak = 0;
          let longestStreak = 0;
          state.roundLog.forEach(log => {
            if (log.robber === null) {
              currentStreak++;
              longestStreak = Math.max(longestStreak, currentStreak);
            } else {
              currentStreak = 0;
            }
          });
          
          // Average round duration
          const totalDuration = state.roundLog.reduce((sum, log) => sum + (log.duration || 0), 0);
          const avgDuration = state.roundLog.length > 0 ? Math.round(totalDuration / state.roundLog.length) : 0;
          
          const probabilityChart = Object.keys(diceCounts).map(num => {
            const actual = totalRolls > 0 ? ((diceCounts[num] / totalRolls) * 100).toFixed(1) : 0;
            const expected = expectedProb[num];
            const diff = totalRolls > 0 ? (actual - expected).toFixed(1) : 0;
            
            return `
              <div class="mb-4">
                <div class="flex justify-between mb-1">
                  <span class="font-bold">${num}</span>
                  <span class="text-sm">
                    <span class="text-blue-400">Actual: ${actual}%</span> | 
                    <span class="text-gray-400">Expected: ${expected}%</span> |
                    <span class="${diff >= 0 ? 'text-green-400' : 'text-red-400'}">${diff > 0 ? '+' : ''}${diff}%</span>
                  </span>
                </div>
                <div class="relative h-8 bg-gray-700 rounded overflow-hidden">
                  <div class="absolute h-full bg-orange-300 opacity-60" style="width: ${expected}%"></div>
                  <div class="absolute h-full bg-blue-500" style="width: ${actual}%"></div>
                  <div class="absolute inset-0 flex items-center justify-center text-xs font-bold">
                    ${diceCounts[num]} rolls
                  </div>
                </div>
              </div>
            `;
          }).join('');
          
          
          content = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
              <div class="bg-gradient-to-br from-purple-600 to-purple-800 p-4 rounded-lg">
                <div class="text-sm opacity-80">Longest Streak (No Robber)</div>
                <div class="text-3xl font-bold">${longestStreak} rounds</div>
              </div>
              <div class="bg-gradient-to-br from-orange-600 to-orange-800 p-4 rounded-lg">
                <div class="text-sm opacity-80">Average Round Duration</div>
                <div class="text-3xl font-bold">${avgDuration}s</div>
              </div>
            </div>
            
            <div class="bg-gray-800 p-6 rounded-lg mb-6">
              <h3 class="text-xl font-bold mb-4">Dice Roll Probability Analysis</h3>
              <p class="text-sm text-gray-400 mb-4">Blue bars show actual rolls, gray bars show expected probability for fair 2d6 dice.</p>
              ${probabilityChart}
              <div class="mt-6 p-4 bg-red-900 bg-opacity-30 rounded border border-red-700">
                <div class="flex justify-between items-center">
                  <span class="font-bold text-red-300">Robber (7s only accepted from round ${state.robberStartRound})</span>
                  <span class="text-2xl font-bold text-red-400">${sevenCount} times</span>
                </div>
              </div>
            </div>
            
          `;
        }
        
        // SETTINGS VIEW
        else if (state.currentView === 'settings') {
          content = `
            <div class="space-y-6">
              <!-- SOUND SETTINGS -->
              <div class="bg-gray-700 p-1 rounded-lg">
                <h2 class="text-xl font-bold mb-4 text-center bg-blue-600 py-2 rounded">üîä Sound Settings</h2>
                
                <div class="bg-gray-800 p-6 rounded-lg">
                  <div class="flex justify-between items-center mb-4">
                    <div>
                      <h3 class="text-lg font-bold">Audio Chime</h3>
                      <p class="text-sm text-gray-400">Play sound during countdown</p>
                    </div>
                    <button onclick="toggleSetting('chimeEnabled')" 
                      class="px-6 py-3 rounded font-bold ${state.chimeEnabled ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-600 hover:bg-gray-700'}">
                      ${state.chimeEnabled ? 'ON' : 'OFF'}
                    </button>
                  </div>
                  
                  <div class="mb-4">
                    <h4 class="text-md font-bold mb-2">Chime Timing</h4>
                    <div class="space-y-2">
                      <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" ${state.chime10sec ? 'checked' : ''} 
                          onchange="toggleSetting('chime10sec')" 
                          class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded">
                        <span class="text-white">10 seconds remaining</span>
                      </label>
                      <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" ${state.chime5sec ? 'checked' : ''} 
                          onchange="toggleSetting('chime5sec')" 
                          class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded">
                        <span class="text-white">5 seconds remaining</span>
                      </label>
                      <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" ${state.chime3sec ? 'checked' : ''} 
                          onchange="toggleSetting('chime3sec')" 
                          class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded">
                        <span class="text-white">3 seconds remaining</span>
                      </label>
                      <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" ${state.chime1sec ? 'checked' : ''} 
                          onchange="toggleSetting('chime1sec')" 
                          class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded">
                        <span class="text-white">1 second remaining</span>
                      </label>
                    </div>
                  </div>
                  
                  <div>
                    <h4 class="text-md font-bold mb-2">Volume (${state.chimeVolume}%)</h4>
                    <div class="flex items-center gap-4 mb-2">
                      <span class="text-sm">üîá</span>
                      <input type="range" min="0" max="100" step="10" value="${state.chimeVolume}" 
                        oninput="updateSetting('chimeVolume', this.value)"
                        class="flex-1 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                      <span class="text-sm">üîä</span>
                    </div>
                    <div class="text-center">
                      <button onclick="playChime()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-sm font-bold">
                        üîä Test Chime
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- VIBRATION SETTINGS -->
              <div class="bg-gray-700 p-1 rounded-lg">
                <h2 class="text-xl font-bold mb-4 text-center bg-purple-600 py-2 rounded">üì≥ Vibration Settings</h2>
                
                <div class="bg-gray-800 p-6 rounded-lg">
                  <div class="flex justify-between items-center mb-4">
                    <div>
                      <h3 class="text-lg font-bold">Vibration</h3>
                      <p class="text-sm text-gray-400">Vibrate device during countdown</p>
                    </div>
                    <button onclick="toggleSetting('vibrationEnabled')" 
                      class="px-6 py-3 rounded font-bold ${state.vibrationEnabled ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-600 hover:bg-gray-700'}">
                      ${state.vibrationEnabled ? 'ON' : 'OFF'}
                    </button>
                  </div>
                  
                  <div>
                    <h4 class="text-md font-bold mb-2">Vibration Timing</h4>
                    <div class="space-y-2">
                      <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" ${state.vibrate10sec ? 'checked' : ''} 
                          onchange="toggleSetting('vibrate10sec')" 
                          class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded">
                        <span class="text-white">10 seconds remaining</span>
                      </label>
                      <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" ${state.vibrate5sec ? 'checked' : ''} 
                          onchange="toggleSetting('vibrate5sec')" 
                          class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded">
                        <span class="text-white">5 seconds remaining</span>
                      </label>
                      <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" ${state.vibrate3sec ? 'checked' : ''} 
                          onchange="toggleSetting('vibrate3sec')" 
                          class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded">
                        <span class="text-white">3 seconds remaining</span>
                      </label>
                      <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" ${state.vibrate1sec ? 'checked' : ''} 
                          onchange="toggleSetting('vibrate1sec')" 
                          class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded">
                        <span class="text-white">1 second remaining</span>
                      </label>
                    </div>
                    <div class="text-center mt-4">
                      <button onclick="testVibration()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded text-sm font-bold">
                        üì≥ Test Vibration
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- FLASH SETTINGS -->
              <div class="bg-gray-700 p-1 rounded-lg">
                <h2 class="text-xl font-bold mb-4 text-center bg-red-600 py-2 rounded">‚ö° Flash Settings</h2>
                
                <div class="bg-gray-800 p-6 rounded-lg space-y-6">
                  <!-- Flash Types -->
                  <div>
                    <h3 class="text-lg font-bold mb-2">Flash Types</h3>
                    <p class="text-sm text-gray-400 mb-3">Choose which flash types to enable (can select both)</p>
                    <div class="space-y-3">
                      <div class="flex items-center gap-3">
                        <input type="checkbox" ${state.flashTextEnabled ? 'checked' : ''} 
                          onchange="toggleSetting('flashTextEnabled')" 
                          class="w-5 h-5 text-red-600 bg-gray-700 border-gray-600 rounded">
                        <div class="flex-1">
                          <span class="text-white font-bold">üìù Text Flash</span>
                          <p class="text-sm text-gray-400">Flash dice, timer, and labels in red</p>
                        </div>
                      </div>
                      <div class="flex items-center gap-3">
                        <input type="checkbox" ${state.flashFullscreenEnabled ? 'checked' : ''} 
                          onchange="toggleSetting('flashFullscreenEnabled')" 
                          class="w-5 h-5 text-red-600 bg-gray-700 border-gray-600 rounded">
                        <div class="flex-1">
                          <span class="text-white font-bold">üì∫ Fullscreen Flash</span>
                          <p class="text-sm text-gray-400">Flash entire screen with custom colour</p>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Fullscreen Flash Colour -->
                  <div>
                    <h3 class="text-lg font-bold mb-2">Fullscreen Flash Colour & Opacity</h3>
                    <p class="text-sm text-gray-400 mb-3">Customise fullscreen flash colour and intensity (text flash is always red)</p>
                    <div class="space-y-3">
                      <div class="flex items-center gap-4">
                        <input type="color" value="${state.flashColor}" 
                          onchange="updateSetting('flashColor', this.value)"
                          class="w-12 h-12 rounded border-2 border-gray-600 cursor-pointer">
                        <span class="text-white font-mono">${state.flashColor}</span>
                        <button onclick="updateSetting('flashColor', '#ff0000')" class="px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-sm">Red</button>
                        <button onclick="updateSetting('flashColor', '#ffff00')" class="px-3 py-1 bg-yellow-500 hover:bg-yellow-600 rounded text-sm">Yellow</button>
                        <button onclick="updateSetting('flashColor', '#ff8800')" class="px-3 py-1 bg-orange-500 hover:bg-orange-600 rounded text-sm">Orange</button>
                      </div>
                      <div>
                        <label class="text-sm font-medium text-gray-300 mb-2 block">Opacity: ${state.flashOpacity}%</label>
                        <div class="flex items-center gap-4">
                          <span class="text-sm">Light</span>
                          <input type="range" min="10" max="80" step="5" value="${state.flashOpacity}" 
                            oninput="updateSetting('flashOpacity', this.value)"
                            class="flex-1 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                          <span class="text-sm">Strong</span>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Flash Timing -->
                  <div>
                    <h3 class="text-lg font-bold mb-2">Flash Timing</h3>
                    <p class="text-sm text-gray-400 mb-3">Start flashing when time reaches (${state.flashThreshold} seconds)</p>
                    <div class="flex items-center gap-4">
                      <button onclick="updateSetting('flashThreshold', ${Math.max(1, state.flashThreshold - 1)})"
                        class="px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded font-bold">‚àí</button>
                      <div class="flex-1 text-center">
                        <div class="text-2xl font-bold">${state.flashThreshold}s</div>
                      </div>
                      <button onclick="updateSetting('flashThreshold', ${Math.min(15, state.flashThreshold + 1)})"
                        class="px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded font-bold">+</button>
                    </div>
                  </div>
                  
                  <!-- Flash Speed -->
                  <div>
                    <h3 class="text-lg font-bold mb-2">Flash Speed</h3>
                    <p class="text-sm text-gray-400 mb-3">How fast the warning flash alternates</p>
                    <div class="flex items-center gap-4">
                      <span class="text-sm">Slow</span>
                      <input type="range" min="${GAME_CONFIG.FLASH_SPEEDS.MIN}" max="${GAME_CONFIG.FLASH_SPEEDS.MAX}" step="${GAME_CONFIG.FLASH_SPEEDS.STEP}" value="${GAME_CONFIG.FLASH_SPEEDS.MAX + GAME_CONFIG.FLASH_SPEEDS.MIN - state.flashSpeed}" 
                        oninput="updateSetting('flashSpeed', ${GAME_CONFIG.FLASH_SPEEDS.MAX} + ${GAME_CONFIG.FLASH_SPEEDS.MIN} - this.value)"
                        class="flex-1 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                      <span class="text-sm">Fast</span>
                    </div>
                    <div class="mt-2 text-center text-sm text-gray-400">
                      Speed: ${state.flashSpeed < 500 ? 'Very Fast' : state.flashSpeed < 700 ? 'Fast' : state.flashSpeed < 900 ? 'Normal' : 'Slow'} (${state.flashSpeed}ms)
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- ROBBER SETTINGS -->
              <div class="bg-gray-700 p-1 rounded-lg">
                <h2 class="text-xl font-bold mb-4 text-center bg-green-600 py-2 rounded">üéØ Robber Settings</h2>
                
                <div class="bg-gray-800 p-6 rounded-lg">
                  <h3 class="text-lg font-bold mb-2">Robber Activation Round</h3>
                  <p class="text-sm text-gray-400 mb-4">Which round the robber becomes active (currently: ${state.robberStartRound})</p>
                  <div class="flex items-center gap-4">
                    <button onclick="updateSetting('robberStartRound', ${Math.max(1, state.robberStartRound - 1)})"
                      class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded font-bold text-xl">‚àí</button>
                    <div class="flex-1 text-center">
                      <div class="text-4xl font-bold">${state.robberStartRound}</div>
                    </div>
                    <button onclick="updateSetting('robberStartRound', ${Math.min(99, state.robberStartRound + 1)})"
                      class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded font-bold text-xl">+</button>
                  </div>
                </div>
              </div>
            </div>
              </div>
            </div>
          `;
        }
        
        // INFO VIEW
        else if (state.currentView === 'info') {
          content = `
            <div class="space-y-6">
              <!-- Keyboard Shortcuts -->
              <div class="bg-gray-800 p-6 rounded-lg">
                <h3 class="text-xl font-bold mb-4">‚å®Ô∏è Keyboard Shortcuts</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <div class="flex justify-between items-centre bg-gray-700 px-4 py-2 rounded">
                    <span class="text-sm">Pause/Resume</span>
                    <kbd class="px-3 py-1 bg-gray-900 rounded font-mono text-xs">SPACE</kbd>
                  </div>
                  <div class="flex justify-between items-centre bg-gray-700 px-4 py-2 rounded">
                    <span class="text-sm">Next Round</span>
                    <kbd class="px-3 py-1 bg-gray-900 rounded font-mono text-xs">N</kbd>
                  </div>
                  <div class="flex justify-between items-centre bg-gray-700 px-4 py-2 rounded">
                    <span class="text-sm">Open Stats</span>
                    <kbd class="px-3 py-1 bg-gray-900 rounded font-mono text-xs">S</kbd>
                  </div>
                </div>
              </div>
              
              <!-- About -->
              <div class="bg-gray-800 p-6 rounded-lg">
                <h3 class="text-xl font-bold mb-4">‚ÑπÔ∏è About Catan Connect</h3>
                <p class="text-sm text-gray-300 mb-4">
                  A digital timer and dice roller for the mega game version of Catan known as <strong>Catan Connect</strong>. 
                  With multiple copies, this game can be played with an exponential number of people, although always at even numbers. 
                  Features automatic round progression, robber mechanics, statistics tracking, and customisable settings.
                </p>
                <p class="text-sm text-gray-300 mb-4">
                  <a href="https://boardgamegeek.com/boardgame/451387/catan-connect" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:text-blue-300 underline">
                    View Catan Connect on BoardGameGeek ‚Üí
                  </a>
                </p>
                <p class="text-xs text-gray-500">
                  Version 1.0 | Built with HTML, CSS & JavaScript
                </p>
              </div>
              
              <!-- Image -->
              <div class="bg-gray-800 p-6 rounded-lg text-centre">
                <img src="Catan_Connect_Front_v1.png" alt="Catan Connect" class="w-full max-w-md mx-auto rounded-lg shadow-lg" onerror="this.style.display='none'">
                <img src="Catan_Connect_Back_v1.png" alt="Catan Connect" class="w-full max-w-md mx-auto rounded-lg shadow-lg" onerror="this.style.display='none'">
              </div>
              
              <!-- Teaching Script -->
              <div class="bg-gray-800 p-6 rounded-lg">
                <h3 class="text-xl font-bold mb-4">üìñ Teaching Script</h3>
                <div class="text-sm text-gray-300 space-y-3 max-h-96 overflow-y-auto">
                  <p class="font-bold text-lg">Welcome to Catan Connect</p>
                  
                  <p>In this fast-paced mega game of Catan you will be racing to 18 points.</p>
                  
                  <p>Each round I will announce whether the moon-side or the sun side is active, and from round 11 onwards whether the robber is robbing.</p>
                  
                  <p>Each round will go for 30 seconds, although I can lengthen this if needed.</p>
                  
                  <p>Every player starts with 1 of each of the resources matching the hexes surrounding their city, and 4 points ‚Äî 2 for their city and 2 for their two settlements.</p>
                  
                  <p>Each player starts on a region of their own, with a robber which can only be moved within your own region.</p>
                  
                  <p>Each time you build your first settlement into the region on your left or right you will gain 2 victory points, and you can mark that on your playmat.</p>
                  
                  <p class="font-bold">There are development tiles which can be purchased from either side of the game mat you are on. These include:</p>
                  
                  <ul class="list-disc list-inside space-y-2 ml-4">
                    <li><strong>Road Building (x1)</strong><br>When you play this tile, build 2 roads at no cost</li>
                    
                    <li><strong>Invention/Year of Plenty (x1)</strong><br>When you play this tile, take any 2 resources from the supply</li>
                    
                    <li><strong>Victory Point (x2)</strong><br>When you are the active player, you may reveal all your Victory Point tiles, including any purchased on that turn, if you can reach the number of VPs needed to win. Otherwise, keep Victory Point tiles face down in front of you</li>
                    
                    <li><strong>Knight (x5)</strong><br>When you play the Knight tile:<br>
                    Move the robber to the desert and take 1 resource corresponding to the hex where the robber was, OR;<br>
                    If the robber is already in the desert, it remains there and you may take 1 resource of your choice from the supply</li>
                  </ul>
                  
                  <p>If you and your direct opponent ever buy all the development tiles from your game mat, you may purchase them from a neighbour's supply.</p>
                  
                  <p>There should be banks of resources within everyone's reach. When a number is rolled that matches the number on a hex you built on, take the resource/s that matches (1 for a settlement and 2 for a city).</p>
                  
                  <p>If there are ever no resources available please throw your hand up so we can replenish the banks.</p>
                  
                  <p class="font-bold">A general turn goes like this:</p>
                  
                  <ol class="list-decimal list-inside space-y-2 ml-4">
                    <li>I will announce which side is active and what the dice roll is</li>
                    <li>All players will collect the resources as per the roll</li>
                    <li>All players can trade with the five people surrounding them</li>
                    <li>All players can trade at trading posts if they have built a settlement or a city there</li>
                    <li>If you are the active player and are at one of the ends you may also trade with the Market. At the market you may, once per turn, trade one resource for another resource at the market.</li>
                    <li>Active players can buy or build any roads, settlements, cities or development tiles</li>
                    <li>Active players can play 1 development tile which they have bought on a previous turn</li>
                    <li>The active player may reveal all their Victory Point tiles, including any purchased this turn, if they can reach the number of VPs needed to win</li>
                  </ol>
                  
                  <p class="font-bold">Sevens can only be rolled after the 11th round.</p>
                  
                  <p>When a robber is rolled you will need to move it to the number on your mat which corresponds with the number I give.</p>
                  
                  <p>The robber doesn't rob in this version of Catan. Instead its purpose is to block.</p>
                  
                  <p>You will have to halve your resource pool however if you have over 7 resources. This is rounded down, so if you have 9 resources you only have to get rid of 4.</p>
                  
                  <p class="font-bold">The competition of Longest Road and Largest Army is only between you and the person sharing your mat.</p>
                  
                  <p>For Longest Road you will need at least 5 of your roads connected, or, after that, more than the other player.</p>
                  
                  <p>For Largest Army you need to have played out at least 2 Knights, or, after that, more than the other player.</p>
                  
                  <p>If you gain either of these, mark the spot on your mat to claim it and move your point marker up 2 spaces.</p>
                  
                  <p>If your opponent takes this achievement from you, they will take your marker to mark on their side on the mat and you will need to put your point tracker down by 2 spaces.</p>
                  
                  <p>Because this is a fast paced game, mistakes will be made, and that is okay. Everyone will make a mistake at some point and the point is to have fun. If you ever need a moment to understand something though, please throw your hand up so I can pause the game.</p>
                  
                  <p class="font-bold text-lg">Does anyone have any questions?</p>
                </div>
              </div>
            </div>
          `;
        }

        // Store current scroll position before render
        const scrollContainer = document.querySelector('.overflow-y-auto');
        const scrollTop = scrollContainer ? scrollContainer.scrollTop : 0;
        
        app.innerHTML = `
          <div class="min-h-screen max-h-screen flex flex-col items-center justify-start bg-gray-900 text-white overflow-hidden" style="position: relative; z-index: 9999;">
            <div class="flex-shrink-0 p-4 md:p-6 w-full max-w-4xl">
              <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                <div class="flex flex-col">
                  <h1 class="text-3xl md:text-4xl font-bold">Catan Connect</h1>
                  ${state.diceNumber !== null ? `
                    <div class="text-lg text-gray-300 mt-1" style="font-size: 1.4em;">
                      <span class="font-bold text-yellow-300">Round ${state.round}</span> ‚Ä¢ 
                      <span class="font-mono font-bold ${state.timeLeft <= 5 ? 'text-red-400' : 'text-white'}">${Math.floor(state.timeLeft / 60)}:${String(state.timeLeft % 60).padStart(2,'0')}</span> 
                      <span class="text-gray-400">${state.isPaused ? '(PAUSED)' : 'remaining'}</span>
                    </div>
                  ` : ''}
                </div>
                <!-- Back to Game Button -->
                <button onclick="closeStats()" title="Back to Game: Return to the main game screen" class="px-6 py-3 bg-blue-600 rounded hover:bg-blue-700 text-base md:text-lg font-bold">
                  ‚Üê Back to Game
                </button>
              </div>
              ${tabs}
            </div>
            <div class="flex-1 overflow-y-auto px-4 md:p-6 pb-4 md:pb-6 w-full" id="statsScrollContainer">
              <div class="w-full max-w-4xl mx-auto">
                ${content}
              </div>
            </div>
          </div>
        `;
        
        // Restore scroll position after render
        setTimeout(() => {
          const newScrollContainer = document.getElementById('statsScrollContainer');
          if (newScrollContainer && scrollTop > 0) {
            newScrollContainer.scrollTop = scrollTop;
          }
        }, 0);
        return;
      }

      // Warning overlay with custom background
      if (state.showWarning) {
        app.innerHTML = `
          <div class="min-h-screen flex items-center justify-center bg-warning">
            <div class="text-center bg-black bg-opacity-50 p-12 rounded-lg">
              <div class="text-6xl font-bold text-white mb-4 animate-pulse">‚ö†Ô∏è WARNING ‚ö†Ô∏è</div>
              <div class="text-4xl font-bold text-white mb-2">THE ROBBERS ARE NOW ACTIVE</div>
              <div class="text-xl text-white mb-8">Rounds will be increased by 10 seconds</div>
              <!-- Continue Button -->
              <button onclick="skipWarning()" title="Continue: Continue with robber active" class="px-8 py-4 bg-white text-2xl font-bold text-green-700 rounded-lg hover:bg-gray-100">
                Continue Game
              </button>
            </div>
          </div>
        `;
        return;
      }

      // Countdown 3-2-1
      if (state.countdownPhase) {
        app.innerHTML = `
          <div class="min-h-screen flex flex-col items-center justify-center bg-gray-900">
            <div class="text-9xl font-bold text-white">${state.countdownValue}</div>
          </div>
        `;
        return;
      }

      // Start screen
      if (state.diceNumber === null) {
        // Check if there's a saved game to continue
        const hasSavedGame = state.roundLog.length > 0 || localStorage.getItem('catanTimerState');
        
        app.innerHTML = `
          <div class="min-h-screen flex flex-col items-center justify-center bg-gradient-to-br from-orange-600 to-amber-700 gap-8 p-6">
            <h1 class="text-6xl font-bold text-white mb-4">Catan Connect</h1>
            
            <div class="flex items-center gap-4 bg-black bg-opacity-40 px-6 py-3 rounded-lg text-white">
              <!-- Decrease Timer Button -->
              <button onclick="adjustRoundTime(-5)" title="Decrease Timer: Decrease round time" class="text-3xl font-bold hover:text-gray-300 px-3">‚àí</button>
              <div class="text-2xl font-bold">${state.roundTime}s per round</div>
              <!-- Increase Timer Button -->
              <button onclick="adjustRoundTime(5)" title="Increase Timer: Increase round time" class="text-3xl font-bold hover:text-gray-300 px-3">+</button>
            </div>

            <div class="flex flex-col gap-4 w-full max-w-md">
              ${hasSavedGame ? `
                <!-- Continue Game Button -->
                <button onclick="handleContinueGame()" title="Continue Game: Resume from saved game state" class="px-8 py-4 bg-green-600 text-2xl font-bold text-white rounded-lg hover:bg-green-700 shadow-lg">
                  üîÑ CONTINUE GAME
                </button>
                <div class="text-center text-white text-sm opacity-90">
                  Resume from Round ${state.round}${state.roundLog.length > 0 ? ` ‚Ä¢ ${state.roundLog.length} rounds played` : ''}
                </div>
                <div class="border-t border-white opacity-30 my-2"></div>
              ` : ''}
              
              <!-- New Game Button -->
              <button onclick="confirmNewGame()" title="New Game: Start a completely fresh game" class="px-8 py-4 bg-white text-2xl font-bold text-orange-700 rounded-lg hover:bg-gray-100 shadow-lg">
                ‚ú® START NEW GAME
              </button>
            </div>

            <p class="text-center text-white opacity-90">
              Don't worry ‚Äî your game saves automatically!
            </p>

            <!-- Settings Button -->
            <button onclick="showStatsPrompt()" title="Settings: View stats, settings, and game info" class="text-lg md:text-xl px-6 py-2 font-bold text-orange-700 bg-black bg-opacity-100 rounded-lg hover:bg-opacity-60 flex items-center gap-2 transition-all"> 
              Settings & Statistics <span style="font-size: 1.2em;">‚öôÔ∏èüìä</span>
            </button>

          </div>
        `;
        return;
      }

      // Main playing view
      let bgClass = state.round % 2 === 0 ? "bg-moon" : "bg-sun";
      if (state.isPaused) {
        bgClass = "bg-gray-600"; // Grey background when paused
      }
      const minutes = String(Math.floor(state.timeLeft / 60)).padStart(2,'0');
      const seconds = String(state.timeLeft % 60).padStart(2,'0');
      
      // Calculate current round length (includes robber bonus if applicable)
      const currentRoundLength = state.round >= GAME_CONFIG.ROBBER_START_ROUND ? 
        state.roundTime + GAME_CONFIG.ROBBER_TIME_BONUS : 
        state.roundTime;

      // Robber case - NO round number displayed
      if (state.diceNumber === 7 && state.round >= 11 && state.robberNumber !== null) {
        const robberDisplay = state.robberNumber === 'Desert' ? 'DESERT (7)' : state.robberNumber;
        const robberBgClass = state.isPaused ? "bg-gray-600" : "bg-warning";
        app.innerHTML = `
          <div class="flex flex-col min-h-screen ${robberBgClass} text-white" style="position: relative;">
            <div style="position: relative; z-index: 10;">
              <div class="absolute top-4 md:top-8 left-4 md:left-8 flex items-center gap-2 md:gap-4 bg-black bg-opacity-40 px-3 md:px-6 py-2 md:py-3 rounded-lg text-sm md:text-base">
                <!-- Decrease Timer Button -->
                <button onclick="adjustRoundTime(-5)" title="Decrease Timer: Decrease round time" class="text-xl md:text-3xl font-bold hover:text-gray-300 px-2 md:px-3">‚àí</button>
                <div class="text-lg md:text-2xl font-bold">${currentRoundLength}s</div>
                <!-- Increase Timer Button -->
                <button onclick="adjustRoundTime(5)" title="Increase Timer: Increase round time" class="text-xl md:text-3xl font-bold hover:text-gray-300 px-2 md:px-3">+</button>
                <div class="h-6 w-px bg-white opacity-30 mx-1 md:mx-2"></div>
                <!-- Menu Button -->
                <button onclick="showStatsPrompt()" title="Menu: For stats, info, settings, or to start a new game" class="text-lg md:text-2xl font-bold hover:text-gray-300">‚öôÔ∏è/üìä</button>
                <!-- Fullscreen Button -->
                <button onclick="toggleFullscreen()" title="Fullscreen: Toggle fullscreen" class="text-lg md:text-2xl font-bold hover:text-gray-300">‚õ∂</button>
              </div>

              <div class="flex-1 flex flex-col items-center justify-center px-4" style="min-height: 100vh;">
                <div class="shaded-rectangle w-full">
                  <div class="robber-label font-bold text-center" style="font-size: clamp(5.2rem, 13vw, 9.1rem); line-height:1.1;">
                    ROBBER ON<br>${robberDisplay}
                  </div>
                </div>
                <div class="text-center" style="font-size: clamp(1.5rem, 4vw, 2.5rem); line-height:1.4; max-width: 90vw;">
                  If you have more than 7 resources,<br>discard half (rounded down)
                </div>

                <div class="timer-text font-mono font-bold mt-4 md:mt-8" style="font-size: clamp(3rem, 10vw, 7rem);">${minutes}:${seconds}</div>

                <div class="flex gap-4 md:gap-6 mt-4 md:mt-6">
                  <!-- Pause/Resume Button -->
                  <button onclick="togglePause()" title="${state.isPaused ? 'Resume: Resume timer' : 'Pause: Pause timer'}" class="p-4 md:p-6 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-full transition-all text-2xl md:text-4xl">${state.isPaused ? '‚ñ∂' : '‚è∏'}</button>
                  <!-- Next Round Button -->
                  <button onclick="handleNext()" title="Next Round: Skip to next round" class="p-4 md:p-6 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-full transition-all text-2xl md:text-4xl">‚è≠</button>
                </div>
              </div>
            </div>
            
            <!-- Paused Overlay -->
            ${state.isPaused ? `
              <div class="absolute inset-0 flex items-center justify-between px-8 md:px-16 pointer-events-none" style="z-index: 20;">
                <div class="text-6xl md:text-8xl font-bold text-white opacity-80 animate-pulse">
                  PAUSED
                </div>
                <div class="text-6xl md:text-8xl font-bold text-white opacity-80 animate-pulse">
                  PAUSED
                </div>
              </div>
            ` : ''}
          </div>
        `;
      } else {
        // Normal display with round number
        const activeLabel = (state.round % 2 === 0) ? "Moon Active" : "Sun Active";
        const activeLabelClass = (state.round % 2 === 0) ? "moon-active" : "sun-active";
        
        app.innerHTML = `
          <div class="flex flex-col min-h-screen ${bgClass} text-white" style="position: relative;">
            <div style="position: relative; z-index: 10;">
              <div class="absolute top-4 md:top-8 left-4 md:left-8 flex items-center gap-2 md:gap-4 bg-black bg-opacity-40 px-3 md:px-6 py-2 md:py-3 rounded-lg text-sm md:text-base">
                <!-- Decrease Timer Button -->
                <button onclick="adjustRoundTime(-5)" title="Decrease Timer: Decrease round time" class="text-xl md:text-3xl font-bold hover:text-gray-300 px-2 md:px-3">‚àí</button>
                <div class="text-lg md:text-2xl font-bold" title="Current round time setting">${currentRoundLength}s</div>
                <!-- Increase Timer Button -->
                <button onclick="adjustRoundTime(5)" title="Increase Timer: Increase round time" class="text-xl md:text-3xl font-bold hover:text-gray-300 px-2 md:px-3">+</button>
                <div class="h-6 w-px bg-white opacity-30 mx-1 md:mx-2"></div>
                <div class="round-number text-lg md:text-2xl font-bold" title="Current round number">R${state.round}</div>
                <div class="h-6 w-px bg-white opacity-30 mx-1 md:mx-2"></div>
                <!-- Menu Button -->
                <button onclick="showStatsPrompt()" title="Menu: For stats, info, settings, or to start a new game" class="text-lg md:text-2xl font-bold hover:text-gray-300">‚öôÔ∏è/üìä</button>
                <!-- Fullscreen Button -->
                <button onclick="toggleFullscreen()" title="Fullscreen: Toggle fullscreen" class="text-lg md:text-2xl font-bold hover:text-gray-300">‚õ∂</button>
              </div>

              <div class="flex-1 flex flex-col items-center justify-center px-4" style="min-height: 100vh;">
                <div class="flex flex-col items-center gap-4 md:gap-8 clamp-center w-full">
                  <div class="shaded-rectangle w-full" title="Current dice roll">
                    <div class="dice-number font-bold">${state.diceNumber}</div>
                    <div class="${activeLabelClass} active-label font-bold" title="Current phase indicator" style="font-size: clamp(3rem, 8vw, 6rem);">${activeLabel}</div>
                  </div>
                  <div class="timer-text font-mono font-bold" title="Time remaining in round" style="font-size: clamp(3rem, 10vw, 7rem);">${minutes}:${seconds}</div>
                </div>

                <div class="flex gap-4 md:gap-6 mt-4 md:mt-6">
                  <!-- Pause/Resume Button -->
                  <button onclick="togglePause()" title="${state.isPaused ? 'Resume: Resume timer' : 'Pause: Pause timer'}" class="p-4 md:p-6 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-full transition-all text-2xl md:text-4xl">${state.isPaused ? '‚ñ∂' : '‚è∏'}</button>
                  <!-- Next Round Button -->
                  <button onclick="handleNext()" title="Next Round: Skip to next round" class="p-4 md:p-6 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-full transition-all text-2xl md:text-4xl">‚è≠</button>
                </div>
              </div>
            </div>
            
            <!-- Paused Overlay -->
            ${state.isPaused ? `
              <div class="absolute inset-0 flex items-center justify-between px-8 md:px-16 pointer-events-none" style="z-index: 20;">
                <div class="text-6xl md:text-8xl font-bold text-white opacity-80 animate-pulse">
                  PAUSED
                </div>
                <div class="text-6xl md:text-8xl font-bold text-white opacity-80 animate-pulse">
                  PAUSED
                </div>
              </div>
            ` : ''}
          </div>
        `;
      }
    }

    // Initial render
    render();
    
    // Load saved state
    loadState();
    
    // Initialize chime audio
    initChime();
    
    // Helper function to reset to default state
    function resetToDefaultState() {
      state.round = 1;
      state.roundTime = GAME_CONFIG.DEFAULT_ROUND_TIME;
      state.timeLeft = GAME_CONFIG.DEFAULT_ROUND_TIME;
      state.isPaused = true;
      state.diceNumber = null;
      state.robberNumber = null;
      state.showWarning = false;
      state.countdownPhase = false;
      state.roundLog = [];
      state.roundStartTime = null;
    }
    
    // Cleanup function to prevent memory leaks
    function cleanup() {
      stopTimerAndFlash();
      if (state.currentCountdownInterval) {
        clearInterval(state.currentCountdownInterval);
        state.currentCountdownInterval = null;
      }
      if (autoSaveInterval) {
        clearInterval(autoSaveInterval);
        autoSaveInterval = null;
      }
      saveState(); // Save final state before cleanup
    }
    
    // Add cleanup on page unload
    window.addEventListener('beforeunload', cleanup);
    window.addEventListener('pagehide', cleanup);
    
    // Add periodic auto-save every 5 seconds during active gameplay
    let autoSaveInterval = setInterval(() => {
      if (!state.isPaused && state.diceNumber !== null) {
        saveState();
      }
    }, 5000);
    
    render();
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Ignore if in stats view or modal
      if (state.showStats || state.showPauseModal) return;
      
      // Spacebar: Toggle pause
      if (e.code === 'Space') {
        e.preventDefault();
        if (state.diceNumber !== null && !state.countdownPhase && !state.showWarning) {
          togglePause();
        }
      }
      
      // N key: Next round
      if (e.code === 'KeyN') {
        e.preventDefault();
        if (state.diceNumber !== null && !state.countdownPhase && !state.showWarning) {
          handleNext();
        }
      }
      
      // S key: Stats
      if (e.code === 'KeyS') {
        e.preventDefault();
        if (state.diceNumber !== null && !state.countdownPhase && !state.showWarning) {
          showStatsPrompt();
        }
      }
    });
  </script>
  <script src="../menu.js"></script>
</body>
</html>